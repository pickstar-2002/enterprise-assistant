# åŸå¸‚å±•å…æ™ºèƒ½è®²è§£å‘˜ - å¼€å‘æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| é¡¹ç›®åç§° | åŸå¸‚å±•å…æ™ºèƒ½è®²è§£å‘˜ |
| èµ›é“ | å¤§å±äº¤äº’ä¸æ™ºèƒ½è®²è§£èµ›é“ |
| æ–¹å‘ | åŸå¸‚å±•å…è®²è§£ï¼šç”ŸåŠ¨è®²è¿°åŸå¸‚å†å²ä¸æœªæ¥è§„åˆ’ |
| æ–‡æ¡£ç‰ˆæœ¬ | v1.3 |
| åˆ›å»ºæ—¥æœŸ | 2025-12-31 |
| æ›´æ–°æ—¥æœŸ | 2026-01-04 |

---

## ç›®å½•

1. [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
2. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
3. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
4. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
5. [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
6. [å¼€å‘ç¯å¢ƒé…ç½®](#å¼€å‘ç¯å¢ƒé…ç½®)
7. [æ ¸å¿ƒæ¨¡å—è®¾è®¡](#æ ¸å¿ƒæ¨¡å—è®¾è®¡)
8. [é­”æ­AIæ¨¡å‹è¿æ¥å®ç°](#é­”æ­aiæ¨¡å‹è¿æ¥å®ç°)
9. [æ•°å­—äººæµå¼è¯´è¯ä¸å¯Œæ–‡æœ¬è¾“å‡º](#æ•°å­—äººæµå¼è¯´è¯ä¸å¯Œæ–‡æœ¬è¾“å‡º)
10. [çŸ¥è¯†åº“ç®¡ç†](#çŸ¥è¯†åº“ç®¡ç†)
11. [å‘é‡æ£€ç´¢ç³»ç»Ÿ](#å‘é‡æ£€ç´¢ç³»ç»Ÿ)
12. [å¤§å±äº¤äº’è®¾è®¡](#å¤§å±äº¤äº’è®¾è®¡)
13. [Widgetå±•ç¤ºåŠŸèƒ½](#widgetå±•ç¤ºåŠŸèƒ½)
14. [å¯†é’¥ç®¡ç†](#å¯†é’¥ç®¡ç†)
15. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
16. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
17. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
18. [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)
19. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)

---

## é¡¹ç›®ç®€ä»‹

### é¡¹ç›®æè¿°

åŸºäºé­”çæ˜Ÿäº‘å…·èº«é©±åŠ¨SDKæ„å»ºçš„åŸå¸‚å±•å…æ™ºèƒ½è®²è§£ç³»ç»Ÿï¼Œé€šè¿‡3Dæ•°å­—äººå‘å‚è§‚è€…ç”ŸåŠ¨è®²è¿°åŸå¸‚çš„å†å²æ–‡åŒ–ã€å‘å±•æˆå°±å’Œæœªæ¥è§„åˆ’ã€‚æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ä¸Šä¼ çŸ¥è¯†åº“ï¼Œè‡ªåŠ¨å‘é‡åŒ–å¤„ç†ï¼Œå®ç°ç²¾å‡†çš„RAGæ£€ç´¢å›ç­”ã€‚é€‚ç”¨äºåŸå¸‚è§„åˆ’é¦†ã€åšç‰©é¦†ã€å±•è§ˆä¸­å¿ƒç­‰åœºæ™¯ã€‚

### åº”ç”¨åœºæ™¯

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| åŸå¸‚è§„åˆ’é¦† | å±•ç¤ºåŸå¸‚å‘å±•å†ç¨‹å’Œæœªæ¥è§„åˆ’ |
| åšç‰©é¦† | ä»‹ç»é¦†è—æ–‡ç‰©å’Œå†å²èƒŒæ™¯ |
| æ—…æ¸¸æ™¯ç‚¹ | æä¾›æ™¯ç‚¹è®²è§£å’Œæ—…æ¸¸æŒ‡å¼• |
| ä¼ä¸šå±•å… | å±•ç¤ºä¼ä¸šå‘å±•å’Œäº§å“ä»‹ç» |
| æ”¿åŠ¡å¤§å… | æ”¿ç­–è§£è¯»å’ŒåŠäº‹æŒ‡å— |

### æŠ€æœ¯äº®ç‚¹

- é­”çæ˜Ÿäº‘3Dæ•°å­—äººé©±åŠ¨
- é­”æ­ç¤¾åŒºAIå¤§æ¨¡å‹æ¥å…¥ï¼ˆQwen3-VLå¤šæ¨¡æ€æ¨¡å‹ï¼‰
- RAGçŸ¥è¯†åº“å¢å¼ºæ£€ç´¢
- ç”¨æˆ·è‡ªå®šä¹‰çŸ¥è¯†åº“ä¸Šä¼ 
- è‡ªåŠ¨å‘é‡åŒ–è½¬æ¢ï¼ˆQwen3-Embedding-8Bï¼‰
- å›¾ç‰‡ç†è§£å’Œå¯¹è¯æ”¯æŒ
- æµå¼å¯¹è¯å“åº”
- å¤§å±äº¤äº’ç•Œé¢è®¾è®¡

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. æ•°å­—äººæ§åˆ¶

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| è¿æ¥/æ–­å¼€ | æ‰‹åŠ¨æ§åˆ¶æ•°å­—äººçš„è¿æ¥ä¸æ–­å¼€ |
| çŠ¶æ€ç®¡ç† | å®æ—¶æ˜¾ç¤ºæ•°å­—äººçŠ¶æ€ï¼ˆåœ¨çº¿/ç¦»çº¿/å¾…æœºç­‰ï¼‰ |
| åŠ¨ä½œæ§åˆ¶ | æ”¯æŒæŒ‡å®šKAåŠ¨ä½œè¿›è¡Œè®²è§£ |
| éŸ³é‡æ§åˆ¶ | å¯è°ƒèŠ‚æ•°å­—äººè¯´è¯éŸ³é‡ |

### 2. æ™ºèƒ½è®²è§£

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| è‡ªç”±å¯¹è¯ | å‚è§‚è€…å¯è‡ªç”±æé—®ï¼ŒAIæ™ºèƒ½å›ç­” |
| ä¸»é¢˜è®²è§£ | é¢„è®¾åŸå¸‚å†å²/è§„åˆ’ç­‰ä¸»é¢˜è®²è§£ |
| æµå¼å“åº” | AIå›ç­”å®æ—¶æµå¼è¾“å‡ºï¼Œæ•°å­—äººåŒæ­¥è®²è§£ |
| å¤šè½®å¯¹è¯ | æ”¯æŒä¸Šä¸‹æ–‡ç†è§£çš„å¤šè½®å¯¹è¯ |
| å›¾ç‰‡é—®ç­” | æ”¯æŒä¸Šä¼ å›¾ç‰‡è¿›è¡Œé—®ç­”ï¼ˆå¤šæ¨¡æ€ï¼‰ |

### 3. çŸ¥è¯†åº“ç®¡ç†

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ–‡ä»¶ä¸Šä¼  | æ”¯æŒTXTã€MDã€PDFã€JSONæ ¼å¼ |
| è‡ªåŠ¨è§£æ | è‡ªåŠ¨æå–æ–‡æœ¬å†…å®¹ |
| å‘é‡åŒ–è½¬æ¢ | ä½¿ç”¨Qwen3-Embedding-8Bè‡ªåŠ¨è½¬æ¢ |
| çŸ¥è¯†åº“é¢„è§ˆ | æŸ¥çœ‹å·²ä¸Šä¼ çš„çŸ¥è¯†åº“å†…å®¹ |
| åˆ é™¤ç®¡ç† | æ”¯æŒåˆ é™¤å•ä¸ªæˆ–å…¨éƒ¨çŸ¥è¯†åº“ |

### 4. å‘é‡æ£€ç´¢

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| è¯­ä¹‰æ£€ç´¢ | åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰åŒ¹é… |
| Top-Kå¬å› | è¿”å›æœ€ç›¸å…³çš„Kä¸ªçŸ¥è¯†ç‰‡æ®µ |
| ä¸Šä¸‹æ–‡å¢å¼º | å°†æ£€ç´¢ç»“æœèå…¥Prompt |
| ç›¸ä¼¼åº¦è¯„åˆ† | æ˜¾ç¤ºæ¯ä¸ªåŒ¹é…ç‰‡æ®µçš„ç›¸ä¼¼åº¦ |

### 5. å¤§å±å±•ç¤º

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| è®²è§£å†…å®¹å±•ç¤º | å®æ—¶æ˜¾ç¤ºå½“å‰è®²è§£æ–‡å­— |
| å›¾ç‰‡/è§†é¢‘å±•ç¤º | æ”¯æŒWidgetå±•ç¤ºç›¸å…³å›¾ç‰‡å’Œè§†é¢‘ |
| å­—å¹•åŒæ­¥ | æ•°å­—äººè¯´è¯æ—¶åŒæ­¥æ˜¾ç¤ºå­—å¹• |
| äº¤äº’é¢æ¿ | æä¾›å¿«æ·æé—®å’Œä¸»é¢˜é€‰æ‹©æŒ‰é’® |

### 6. å¯†é’¥ç®¡ç†

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æœ¬åœ°å­˜å‚¨ | å¯†é’¥å­˜å‚¨åœ¨localStorageä¸­ |
| æµ‹è¯•å¯†é’¥ | æä¾›å†…ç½®æµ‹è¯•å¯†é’¥ä¾›å¿«é€Ÿä½“éªŒ |
| æ‰‹åŠ¨è¾“å…¥ | æ”¯æŒç”¨æˆ·æ‰‹åŠ¨è¾“å…¥è‡ªå·±çš„å¯†é’¥ |
| å®‰å…¨æç¤º | å¯†é’¥ä»…åœ¨æœ¬åœ°ä½¿ç”¨ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨ |

---

## æŠ€æœ¯æ ˆ

### å‰ç«¯æŠ€æœ¯æ ˆ

```yaml
æ¡†æ¶: React 18.x + TypeScript
æ„å»ºå·¥å…·: Vite 6.x
çŠ¶æ€ç®¡ç†: Zustand
æ ·å¼æ–¹æ¡ˆ: TailwindCSS
HTTPå®¢æˆ·ç«¯: Axios
æ–‡ä»¶ä¸Šä¼ : FormData API
æœ¬åœ°å­˜å‚¨: localStorage
å…¶ä»–:
  - react-dropzone: æ‹–æ‹½ä¸Šä¼ 
  - react-use: React Hooks å·¥å…·åº“
```

### åç«¯æŠ€æœ¯æ ˆ

```yaml
è¿è¡Œç¯å¢ƒ: Node.js 18.x
æ¡†æ¶: Express + TypeScript
AIæœåŠ¡: é­”æ­ç¤¾åŒº (ModelScope OpenAIå…¼å®¹API)
åµŒå…¥æ¨¡å‹: Qwen/Qwen3-Embedding-8B
å¯¹è¯æ¨¡å‹: Qwen/Qwen3-VL-235B-A22B-Instruct
å‘é‡å­˜å‚¨: å†…å­˜å‘é‡å­˜å‚¨ (æ”¯æŒæ‰©å±•åˆ°ä¸“ä¸šå‘é‡æ•°æ®åº“)
æ–‡ä»¶è§£æ:
  - pdf-parse: PDFæ–‡ä»¶è§£æ
  - marked: Markdownè§£æ
å…¶ä»–:
  - cors: è·¨åŸŸå¤„ç†
  - multer: æ–‡ä»¶ä¸Šä¼ 
  - dotenv: ç¯å¢ƒå˜é‡
  - uuid: å”¯ä¸€æ ‡è¯†ç¬¦
```

### å…·èº«é©±åŠ¨SDK

```yaml
SDKåç§°: é­”çæ˜Ÿäº‘å…·èº«é©±åŠ¨SDK
ç‰ˆæœ¬: 0.1.0-alpha.72 (æœ€æ–°ç‰ˆæœ¬)
æ¥å…¥æ–¹å¼: JavaScript CDN
Gateway: https://nebula-agent.xingyun3d.com/user/v1/ttsa/session
```

---

## æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®¢æˆ·ç«¯å±‚ (Browser)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  React UI    â”‚  â”‚  æ˜Ÿäº‘SDKå±‚   â”‚  â”‚  å¯†é’¥ç®¡ç†    â”‚  â”‚ çŸ¥è¯†åº“ä¸Šä¼  â”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚           â”‚  â”‚
â”‚  â”‚ - å¤§å±ç•Œé¢   â”‚â—„â”€â”¤ - 3Dæ•°å­—äºº   â”‚â—„â”€â”¤ - localStorageâ”‚  â”‚- æ–‡ä»¶é€‰æ‹© â”‚  â”‚
â”‚  â”‚ - è¯­éŸ³è¾“å…¥   â”‚  â”‚ - è¯­éŸ³åˆæˆ   â”‚  â”‚ - æµ‹è¯•å¯†é’¥   â”‚  â”‚- æ‹–æ‹½ä¸Šä¼  â”‚  â”‚
â”‚  â”‚ - Widgetå±•ç¤º â”‚  â”‚ - åŠ¨ä½œæ§åˆ¶   â”‚  â”‚ - æ‰‹åŠ¨è¾“å…¥   â”‚  â”‚- è¿›åº¦æ˜¾ç¤º â”‚  â”‚
â”‚  â”‚ - å›¾ç‰‡ä¸Šä¼    â”‚  â”‚              â”‚  â”‚              â”‚  â”‚- é¢„è§ˆç®¡ç† â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
                    â–¼               â–¼               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   æ–‡ä»¶ä¸Šä¼ API    â”‚ â”‚  å¯¹è¯API     â”‚ â”‚  å¯†é’¥éªŒè¯    â”‚
         â”‚   /knowledge     â”‚ â”‚  /chat       â”‚ â”‚  /api        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                  â”‚
                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æœåŠ¡ç«¯å±‚ (Node.js)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  APIæœåŠ¡     â”‚  â”‚  AIæœåŠ¡      â”‚  â”‚  å‘é‡æœåŠ¡    â”‚  â”‚ æ–‡ä»¶æœåŠ¡  â”‚  â”‚
â”‚  â”‚  (Express)   â”‚  â”‚  (ModelScope)â”‚  â”‚  (RAG)       â”‚  â”‚           â”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚           â”‚  â”‚
â”‚  â”‚ - /chat      â”‚â”€â–ºâ”‚ - Qwen3-VL   â”‚â—„â”€â”‚ - Embedding  â”‚â—„â”€â”‚ - æ–‡ä»¶è§£æ â”‚  â”‚
â”‚  â”‚ - /knowledge â”‚  â”‚ - Qwen3-Emb  â”‚  â”‚ - å‘é‡å­˜å‚¨   â”‚  â”‚- æ–‡æœ¬æå– â”‚  â”‚
â”‚  â”‚ - /upload    â”‚  â”‚ - æµå¼å“åº”   â”‚  â”‚ - ç›¸ä¼¼åº¦è®¡ç®— â”‚  â”‚- æ ¼å¼è½¬æ¢ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   å‘é‡çŸ¥è¯†åº“å­˜å‚¨      â”‚
                         â”‚                      â”‚
                         â”‚ - æ–‡æœ¬å‘é‡           â”‚
                         â”‚ - å…ƒæ•°æ®             â”‚
                         â”‚ - ç´¢å¼•               â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RAGæ£€ç´¢æµç¨‹å›¾

```
ç”¨æˆ·æé—®
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é‡åŒ–æŸ¥è¯¢     â”‚
â”‚  (Qwen3-Embed)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é‡ç›¸ä¼¼åº¦è®¡ç®— â”‚â”€â”€â”€â”€â–ºâ”‚ Top-Kå¬å›    â”‚
â”‚  (ä½™å¼¦ç›¸ä¼¼åº¦)   â”‚     â”‚ å–å‰5ä¸ªç‰‡æ®µ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸Šä¸‹æ–‡æ„å»º     â”‚
â”‚  æ‹¼æ¥Prompt     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLMç”Ÿæˆå›ç­”    â”‚â”€â”€â”€â”€â–ºâ”‚ æ•°å­—äººè®²è§£   â”‚
â”‚  (Qwen3-VL)     â”‚     â”‚ æµå¼è¾“å‡º     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç›®å½•ç»“æ„

```
city-exhibition-guide/
â”œâ”€â”€ src/                         # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ client/                  # å‰ç«¯ä»£ç  (React + TypeScript)
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ Avatar/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AvatarController.ts      # SDKæ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AvatarContainer.tsx      # æ•°å­—äººå®¹å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ Chat/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ChatInput.tsx            # è¾“å…¥æ¡†ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageList.tsx          # æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ImageUpload.tsx          # å›¾ç‰‡ä¸Šä¼ ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Settings/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ApiKeyPanel.tsx          # å¯†é’¥é…ç½®é¢æ¿
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TestKeyProvider.tsx      # æµ‹è¯•å¯†é’¥è¯´æ˜
â”‚   â”‚   â”‚   â”œâ”€â”€ Exhibition/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ThemeSelector.tsx        # ä¸»é¢˜é€‰æ‹©å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ContentDisplay.tsx       # å†…å®¹å±•ç¤ºç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Widget/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ImageWidget.tsx          # å›¾ç‰‡Widgetç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ VideoWidget.tsx          # è§†é¢‘Widgetç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ Knowledge/
â”‚   â”‚   â”‚       â”œâ”€â”€ KnowledgeUploader.tsx    # çŸ¥è¯†åº“ä¸Šä¼ ç»„ä»¶
â”‚   â”‚   â”‚       â”œâ”€â”€ FileDropzone.tsx         # æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ
â”‚   â”‚   â”‚       â””â”€â”€ KnowledgeList.tsx        # çŸ¥è¯†åº“åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â”‚   â”œâ”€â”€ chatStore.ts                 # å¯¹è¯çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ avatarStore.ts               # æ•°å­—äººçŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ knowledgeStore.ts            # çŸ¥è¯†åº“çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ chatService.ts               # å‰ç«¯APIæœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ storageService.ts            # localStorageæœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ uploadService.ts             # æ–‡ä»¶ä¸Šä¼ æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                     # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ App.tsx                          # ä¸»åº”ç”¨ç»„ä»¶
â”‚   â”‚   â””â”€â”€ main.tsx                         # å…¥å£æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ server/                 # åç«¯ä»£ç  (Node.js + TypeScript)
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.routes.ts                # å¯¹è¯è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ themes.routes.ts             # ä¸»é¢˜è®²è§£è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge.routes.ts          # çŸ¥è¯†åº“ç®¡ç†è·¯ç”±
â”‚   â”‚   â”‚   â””â”€â”€ upload.routes.ts             # æ–‡ä»¶ä¸Šä¼ è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ chatService.ts                # å¯¹è¯å¤„ç†æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ modelscopeService.ts          # é­”æ­AIæœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ embeddingService.ts          # å‘é‡åŒ–æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ vectorStoreService.ts         # å‘é‡å­˜å‚¨æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ fileParserService.ts         # æ–‡ä»¶è§£ææœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ ragService.ts                 # RAGæ£€ç´¢æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â”œâ”€â”€ error.middleware.ts           # é”™è¯¯å¤„ç†
â”‚   â”‚   â”‚   â””â”€â”€ upload.middleware.ts         # æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ app.ts                            # Expressåº”ç”¨å…¥å£
â”‚   â”‚
â”‚   â””â”€â”€ shared/                 # å…±äº«ä»£ç 
â”‚       â””â”€â”€ types/               # å…±äº«ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ uploads/                     # ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½•
â”‚   â””â”€â”€ knowledge/               # çŸ¥è¯†åº“æ–‡ä»¶
â”‚
â”œâ”€â”€ data/                        # å†…ç½®åŸå¸‚çŸ¥è¯†åº“æ•°æ®
â”‚   â””â”€â”€ knowledge/
â”‚       â”œâ”€â”€ city-history.json               # åŸå¸‚å†å²
â”‚       â”œâ”€â”€ future-planning.json             # æœªæ¥è§„åˆ’
â”‚       â”œâ”€â”€ cultural-attractions.json        # æ–‡åŒ–æ™¯ç‚¹
â”‚       â””â”€â”€ urban-development.json           # åŸå¸‚å‘å±•
â”‚
â”œâ”€â”€ public/                      # é™æ€èµ„æº
â”œâ”€â”€ package.json                 # é¡¹ç›®é…ç½®
â”œâ”€â”€ vite.config.ts              # Viteé…ç½®
â”œâ”€â”€ tsconfig.json               # TypeScripté…ç½® (å‰ç«¯)
â”œâ”€â”€ tsconfig.server.json        # TypeScripté…ç½® (åç«¯)
â”œâ”€â”€ tailwind.config.js          # TailwindCSSé…ç½®
â”œâ”€â”€ postcss.config.js           # PostCSSé…ç½®
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

---

## å¼€å‘ç¯å¢ƒé…ç½®

### å®Œæ•´ä¾èµ–é…ç½®

**package.json**
```json
{
  "name": "city-exhibition-guide",
  "version": "1.0.0",
  "description": "åŸå¸‚å±•å…æ™ºèƒ½è®²è§£å‘˜ - é­”æ³•æ˜Ÿäº‘é»‘å®¢æ¾2025å‚èµ›ä½œå“",
  "type": "module",
  "scripts": {
    "dev": "concurrently \"npm run dev:client\" \"npm run dev:server\"",
    "dev:client": "vite",
    "dev:server": "tsx watch src/server/app.ts",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "start": "node dist/server/app.js"
  },
  "dependencies": {
    "@vitejs/plugin-react": "^4.3.4",
    "axios": "^1.7.9",
    "cors": "^2.8.5",
    "dotenv": "^16.4.7",
    "express": "^4.21.2",
    "openai": "^4.77.3",
    "pdf-parse": "^1.1.1",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-dropzone": "^14.3.5",
    "marked": "^15.0.4",
    "uuid": "^11.0.3",
    "zustand": "^5.0.2",
    "react-use": "^17.5.1"
  },
  "devDependencies": {
    "@types/cors": "^2.8.17",
    "@types/express": "^5.0.0",
    "@types/node": "^22.10.5",
    "@types/pdf-parse": "^1.1.4",
    "@types/react": "^18.3.18",
    "@types/react-dom": "^18.3.5",
    "@types/uuid": "^10.0.0",
    "autoprefixer": "^10.4.20",
    "concurrently": "^9.1.2",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.17",
    "tsx": "^4.19.2",
    "typescript": "^5.7.2",
    "vite": "^6.0.7"
  }
}
```

### å‰ç«¯ç¯å¢ƒé…ç½®

**vite.config.ts**
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true
      },
      '/uploads': {
        target: 'http://localhost:3001',
        changeOrigin: true
      }
    }
  }
})
```

### åç«¯ç¯å¢ƒé…ç½®

**.env.server**
```bash
# æœåŠ¡å™¨é…ç½®
PORT=3001
NODE_ENV=development

# é­”æ­AIé…ç½® (ä½¿ç”¨OpenAIå…¼å®¹API)
MODELSCOPE_API_KEY=
MODELSCOPE_BASE_URL=https://api-inference.modelscope.cn/v1
MODELSCOPE_EMBEDDING_MODEL=Qwen/Qwen3-Embedding-8B
MODELSCOPE_CHAT_MODEL=Qwen/Qwen3-VL-235B-A22B-Instruct

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_DIR=./uploads/knowledge
MAX_FILE_SIZE=10485760
ALLOWED_EXTENSIONS=.txt,.md,.pdf,.json

# å‘é‡æ£€ç´¢é…ç½®
TOP_K_RESULTS=5
SIMILARITY_THRESHOLD=0.6

# å†…ç½®æµ‹è¯•å¯†é’¥ (ç”¨äºæ¼”ç¤º)
TEST_MODELSCOPE_KEY=ms-de3c153b-5a19-41d1-bd3e-257a7eef7922
TEST_AVATAR_APP_ID=test_app_id
TEST_AVATAR_SECRET=test_app_secret
```

---

## æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. é­”æ­AIæœåŠ¡ï¼ˆModelScope OpenAIå…¼å®¹ï¼‰

**modelscopeService.ts**
```typescript
import OpenAI from 'openai';

export interface ChatMessage {
  role: 'system' | 'user' | 'assistant';
  content: string | Array<{ type: string; text?: string; image_url?: { url: string } }>;
}

export class ModelScopeService {
  private client: OpenAI;
  private embeddingModel: string;
  private chatModel: string;

  constructor(apiKey: string) {
    this.client = new OpenAI({
      apiKey: apiKey,
      baseURL: 'https://api-inference.modelscope.cn/v1'
    });
    this.embeddingModel = 'Qwen/Qwen3-Embedding-8B';
    this.chatModel = 'Qwen/Qwen3-VL-235B-A22B-Instruct';
  }

  /**
   * ç”Ÿæˆæ–‡æœ¬å‘é‡
   */
  async generateEmbedding(text: string): Promise<number[]> {
    try {
      const response = await this.client.embeddings.create({
        model: this.embeddingModel,
        input: text,
        encoding_format: 'float'
      });

      return response.data[0].embedding;
    } catch (error) {
      console.error('Embedding Error:', error);
      throw new Error('å‘é‡åŒ–å¤±è´¥');
    }
  }

  /**
   * æ‰¹é‡ç”Ÿæˆå‘é‡
   */
  async generateEmbeddingsBatch(texts: string[]): Promise<number[][]> {
    const embeddings: number[][] = [];

    for (const text of texts) {
      const embedding = await this.generateEmbedding(text);
      embeddings.push(embedding);
    }

    return embeddings;
  }

  /**
   * æ™®é€šå¯¹è¯
   */
  async chat(messages: ChatMessage[]): Promise<string> {
    try {
      const response = await this.client.chat.completions.create({
        model: this.chatModel,
        messages: messages as any,
        stream: false
      });

      return response.choices[0].message.content || '';
    } catch (error) {
      console.error('Chat Error:', error);
      throw new Error('å¯¹è¯ç”Ÿæˆå¤±è´¥');
    }
  }

  /**
   * æµå¼å¯¹è¯
   */
  async *chatStream(messages: ChatMessage[]): AsyncGenerator<string> {
    try {
      const stream = await this.client.chat.completions.create({
        model: this.chatModel,
        messages: messages as any,
        stream: true
      });

      for await (const chunk of stream) {
        const content = chunk.choices[0]?.delta?.content;
        if (content) {
          yield content;
        }
      }
    } catch (error) {
      console.error('Stream Error:', error);
      throw new Error('æµå¼å¯¹è¯å¤±è´¥');
    }
  }

  /**
   * å›¾ç‰‡ç†è§£å¯¹è¯
   */
  async chatWithImage(imageUrl: string, question: string): Promise<string> {
    const messages: ChatMessage[] = [{
      role: 'user',
      content: [
        { type: 'text', text: question },
        { type: 'image_url', image_url: { url: imageUrl } }
      ]
    }];

    return await this.chat(messages);
  }
}

export default ModelScopeService;
```

### 2. å‘é‡å­˜å‚¨æœåŠ¡

**vectorStoreService.ts**
```typescript
import { v4 as uuidv4 } from 'uuid';

export interface VectorDocument {
  id: string;
  content: string;
  embedding: number[];
  metadata: {
    filename: string;
    uploadTime: number;
    chunkIndex: number;
    [key: string]: any;
  };
}

export class VectorStoreService {
  private documents: Map<string, VectorDocument> = new Map();

  /**
   * æ·»åŠ æ–‡æ¡£
   */
  addDocument(content: string, embedding: number[], metadata: any): string {
    const doc: VectorDocument = {
      id: uuidv4(),
      content,
      embedding,
      metadata: {
        ...metadata,
        uploadTime: Date.now()
      }
    };

    this.documents.set(doc.id, doc);
    return doc.id;
  }

  /**
   * æ‰¹é‡æ·»åŠ æ–‡æ¡£
   */
  addDocumentsBatch(items: Array<{ content: string; embedding: number[]; metadata: any }>): string[] {
    return items.map(item => this.addDocument(item.content, item.embedding, item.metadata));
  }

  /**
   * è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
   */
  private cosineSimilarity(vec1: number[], vec2: number[]): number {
    let dotProduct = 0;
    let norm1 = 0;
    let norm2 = 0;

    for (let i = 0; i < vec1.length; i++) {
      dotProduct += vec1[i] * vec2[i];
      norm1 += vec1[i] * vec1[i];
      norm2 += vec2[i] * vec2[i];
    }

    return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
  }

  /**
   * å‘é‡æ£€ç´¢
   */
  search(queryEmbedding: number[], topK: number = 5, threshold: number = 0.6): Array<{
    doc: VectorDocument;
    score: number;
  }> {
    const results: Array<{ doc: VectorDocument; score: number }> = [];

    for (const doc of this.documents.values()) {
      const score = this.cosineSimilarity(queryEmbedding, doc.embedding);

      if (score >= threshold) {
        results.push({ doc, score });
      }
    }

    // æŒ‰ç›¸ä¼¼åº¦é™åºæ’åº
    results.sort((a, b) => b.score - a.score);

    // è¿”å›Top-K
    return results.slice(0, topK);
  }

  /**
   * è·å–æ‰€æœ‰æ–‡æ¡£
   */
  getAllDocuments(): VectorDocument[] {
    return Array.from(this.documents.values());
  }

  /**
   * åˆ é™¤æ–‡æ¡£
   */
  deleteDocument(id: string): boolean {
    return this.documents.delete(id);
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰æ–‡æ¡£
   */
  clearAll(): void {
    this.documents.clear();
  }

  /**
   * è·å–ç»Ÿè®¡ä¿¡æ¯
   */
  getStats() {
    return {
      totalDocuments: this.documents.size,
      filenames: [...new Set(Array.from(this.documents.values()).map(d => d.metadata.filename))]
    };
  }
}

export default new VectorStoreService();
```

### 3. RAGæ£€ç´¢æœåŠ¡

**ragService.ts**
```typescript
import ModelScopeService from './modelscopeService';
import vectorStoreService from './vectorStoreService';

export interface RetrievalResult {
  content: string;
  score: number;
  metadata: any;
}

export class RAGService {
  private modelScopeService: ModelScopeService | null = null;

  setModelScopeService(service: ModelScopeService) {
    this.modelScopeService = service;
  }

  /**
   * æ£€ç´¢ç›¸å…³æ–‡æ¡£
   */
  async retrieveDocuments(
    query: string,
    topK: number = 5,
    threshold: number = 0.6
  ): Promise<RetrievalResult[]> {
    if (!this.modelScopeService) {
      throw new Error('ModelScope service not initialized');
    }

    // 1. å°†æŸ¥è¯¢å‘é‡åŒ–
    const queryEmbedding = await this.modelScopeService.generateEmbedding(query);

    // 2. å‘é‡æ£€ç´¢
    const searchResults = vectorStoreService.search(queryEmbedding, topK, threshold);

    // 3. æ ¼å¼åŒ–ç»“æœ
    return searchResults.map(result => ({
      content: result.doc.content,
      score: result.score,
      metadata: result.doc.metadata
    }));
  }

  /**
   * æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡
   */
  async buildRAGContext(query: string): Promise<string> {
    const docs = await this.retrieveDocuments(query, 5, 0.5);

    if (docs.length === 0) {
      return '';
    }

    let context = 'å‚è€ƒçŸ¥è¯†åº“å†…å®¹ï¼š\n\n';
    docs.forEach((doc, index) => {
      context += `[${index + 1}] ${doc.content}\n`;
      context += `(ç›¸ä¼¼åº¦: ${(doc.score * 100).toFixed(1)}% | æ¥æº: ${doc.metadata.filename})\n\n`;
    });

    return context;
  }

  /**
   * æ·»åŠ æ–‡æ¡£åˆ°çŸ¥è¯†åº“
   */
  async addDocumentsToKnowledge(
    items: Array<{ content: string; metadata: any }>,
    apiKey: string
  ): Promise<void> {
    if (!this.modelScopeService) {
      this.modelScopeService = new ModelScopeService(apiKey);
    }

    // æ‰¹é‡ç”Ÿæˆå‘é‡
    const texts = items.map(item => item.content);
    const embeddings = await this.modelScopeService.generateEmbeddingsBatch(texts);

    // æ·»åŠ åˆ°å‘é‡å­˜å‚¨
    const docs = items.map((item, index) => ({
      content: item.content,
      embedding: embeddings[index],
      metadata: item.metadata
    }));

    vectorStoreService.addDocumentsBatch(docs);
  }

  /**
   * è·å–çŸ¥è¯†åº“ç»Ÿè®¡
   */
  getKnowledgeStats() {
    return vectorStoreService.getStats();
  }

  /**
   * æ¸…ç©ºçŸ¥è¯†åº“
   */
  clearKnowledge() {
    vectorStoreService.clearAll();
  }
}

export default new RAGService();
```

### 4. æ–‡ä»¶è§£ææœåŠ¡

**fileParserService.ts**
```typescript
import fs from 'fs';
import pdf from 'pdf-parse';
import { marked } from 'marked';

export interface ParsedContent {
  text: string;
  chunks: string[];
  metadata: {
    filename: string;
    fileType: string;
    chunkCount: number;
  };
}

export class FileParserService {
  /**
   * è§£ææ–‡ä»¶
   */
  async parseFile(filePath: string, filename: string): Promise<ParsedContent> {
    const ext = filename.substring(filename.lastIndexOf('.')).toLowerCase();
    let text = '';

    switch (ext) {
      case '.txt':
        text = await this.parseTxt(filePath);
        break;
      case '.md':
        text = await this.parseMarkdown(filePath);
        break;
      case '.pdf':
        text = await this.parsePdf(filePath);
        break;
      case '.json':
        text = await this.parseJson(filePath);
        break;
      default:
        throw new Error(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${ext}`);
    }

    // åˆ†å—å¤„ç†
    const chunks = this.chunkText(text, 500);

    return {
      text,
      chunks,
      metadata: {
        filename,
        fileType: ext,
        chunkCount: chunks.length
      }
    };
  }

  /**
   * è§£æTXTæ–‡ä»¶
   */
  private async parseTxt(filePath: string): Promise<string> {
    return fs.promises.readFile(filePath, 'utf-8');
  }

  /**
   * è§£æMarkdownæ–‡ä»¶
   */
  private async parseMarkdown(filePath: string): Promise<string> {
    const content = await fs.promises.readFile(filePath, 'utf-8');
    // Markdownè½¬çº¯æ–‡æœ¬
    return content;
  }

  /**
   * è§£æPDFæ–‡ä»¶
   */
  private async parsePdf(filePath: string): Promise<string> {
    const dataBuffer = fs.readFileSync(filePath);
    const data = await pdf(dataBuffer);
    return data.text;
  }

  /**
   * è§£æJSONæ–‡ä»¶
   */
  private async parseJson(filePath: string): Promise<string> {
    const content = await fs.promises.readFile(filePath, 'utf-8');
    const jsonData = JSON.parse(content);
    return JSON.stringify(jsonData, null, 2);
  }

  /**
   * æ–‡æœ¬åˆ†å—ï¼ˆæŒ‰æ®µè½å’Œé•¿åº¦ï¼‰
   */
  private chunkText(text: string, maxChunkSize: number): string[] {
    // æŒ‰æ®µè½åˆ†å‰²
    const paragraphs = text.split(/\n\n+/);
    const chunks: string[] = [];
    let currentChunk = '';

    for (const paragraph of paragraphs) {
      if ((currentChunk + paragraph).length > maxChunkSize && currentChunk) {
        chunks.push(currentChunk.trim());
        currentChunk = paragraph;
      } else {
        currentChunk += (currentChunk ? '\n\n' : '') + paragraph;
      }
    }

    if (currentChunk) {
      chunks.push(currentChunk.trim());
    }

    return chunks;
  }
}

export default new FileParserService();
```

---

## é­”æ­AIæ¨¡å‹è¿æ¥å®ç°

### æ¦‚è¿°

é¡¹ç›®ä½¿ç”¨é­”æ­ç¤¾åŒºï¼ˆModelScopeï¼‰çš„ä¸¤ä¸ªAIæ¨¡å‹ï¼š
- **Qwen3-Embedding-8B**ï¼šç”¨äºæ–‡æœ¬å‘é‡åŒ–ï¼ˆRAGæ£€ç´¢ï¼‰
- **Qwen3-VL-235B-A22B-Instruct**ï¼šç”¨äºå¯¹è¯ç”Ÿæˆï¼ˆå¤šæ¨¡æ€æ”¯æŒï¼‰

é€šè¿‡OpenAIå…¼å®¹APIæ¥å…¥ï¼Œä½¿ç”¨`openai` npmåŒ…è¿›è¡Œè¿æ¥ã€‚

### æ ¸å¿ƒæœåŠ¡å°è£…

**æ–‡ä»¶ä½ç½®**: `src/server/services/modelscopeService.ts`

```typescript
import OpenAI from 'openai';
import type { ChatMessage } from '../../shared/types/index.js';

export interface ChatStreamOptions {
  messages: ChatMessage[];
  temperature?: number;
  maxTokens?: number;
}

export class ModelScopeService {
  private client: OpenAI;
  private embeddingModel: string;
  private chatModel: string;

  constructor(apiKey: string) {
    // ä½¿ç”¨ OpenAI å…¼å®¹ API è¿æ¥é­”æ­ç¤¾åŒº
    this.client = new OpenAI({
      apiKey: apiKey,
      baseURL: 'https://api-inference.modelscope.cn/v1'
    });
    this.embeddingModel = 'Qwen/Qwen3-Embedding-8B';
    this.chatModel = 'Qwen/Qwen3-VL-235B-A22B-Instruct';
  }

  /**
   * ç”Ÿæˆæ–‡æœ¬å‘é‡ï¼ˆä½¿ç”¨ Qwen3-Embedding-8Bï¼‰
   */
  async generateEmbedding(text: string): Promise<number[]> {
    try {
      const response = await this.client.embeddings.create({
        model: this.embeddingModel,
        input: text,
        encoding_format: 'float'
      });

      return Array.from(response.data[0].embedding);
    } catch (error: any) {
      console.error('[ModelScope] Embedding Error:', error);
      if (error.response?.data?.error) {
        throw new Error(error.response.data.error.message || 'å‘é‡åŒ–å¤±è´¥');
      }
      throw error;
    }
  }

  /**
   * æ‰¹é‡ç”Ÿæˆå‘é‡
   */
  async generateEmbeddingsBatch(texts: string[]): Promise<number[][]> {
    const embeddings: number[][] = [];
    for (const text of texts) {
      const embedding = await this.generateEmbedding(text);
      embeddings.push(embedding);
    }
    return embeddings;
  }

  /**
   * æ™®é€šå¯¹è¯ï¼ˆä½¿ç”¨ Qwen3-VL-235B-A22B-Instructï¼‰
   */
  async chat(messages: ChatMessage[]): Promise<string> {
    try {
      const response = await this.client.chat.completions.create({
        model: this.chatModel,
        messages: messages as any,
        stream: false
      });

      return response.choices[0].message.content || '';
    } catch (error) {
      console.error('[ModelScope] Chat Error:', error);
      throw new Error('å¯¹è¯ç”Ÿæˆå¤±è´¥');
    }
  }

  /**
   * æµå¼å¯¹è¯
   */
  async *chatStream(messages: ChatMessage[]): AsyncGenerator<string> {
    try {
      const stream = await this.client.chat.completions.create({
        model: this.chatModel,
        messages: messages as any,
        stream: true
      });

      for await (const chunk of stream) {
        const content = chunk.choices[0]?.delta?.content;
        if (content) {
          yield content;
        }
      }
    } catch (error) {
      console.error('[ModelScope] Stream Error:', error);
      throw new Error('æµå¼å¯¹è¯å¤±è´¥');
    }
  }

  /**
   * å›¾ç‰‡ç†è§£å¯¹è¯ï¼ˆå¤šæ¨¡æ€ï¼‰
   */
  async chatWithImage(imageUrl: string, question: string): Promise<string> {
    const messages: ChatMessage[] = [{
      role: 'user',
      content: [
        { type: 'text', text: question },
        { type: 'image_url', image_url: { url: imageUrl } }
      ]
    }];

    return await this.chat(messages);
  }
}

export default ModelScopeService;
```

### RAGæ£€ç´¢æœåŠ¡é›†æˆ

**æ–‡ä»¶ä½ç½®**: `src/server/services/ragService.ts`

```typescript
import ModelScopeService from './modelscopeService.js';
import vectorStoreService from './vectorStoreService.js';
import type { VectorSearchResult } from '../../shared/types/index.js';

export class RAGService {
  private modelScopeService: ModelScopeService | null = null;

  setModelScopeService(service: ModelScopeService) {
    this.modelScopeService = service;
  }

  /**
   * æ£€ç´¢ç›¸å…³æ–‡æ¡£
   */
  async retrieveDocuments(
    query: string,
    topK: number = 5,
    threshold: number = 0.6
  ): Promise<VectorSearchResult[]> {
    if (!this.modelScopeService) {
      throw new Error('ModelScope service not initialized');
    }

    // 1. å°†æŸ¥è¯¢å‘é‡åŒ–
    const queryEmbedding = await this.modelScopeService.generateEmbedding(query);

    // 2. å‘é‡æ£€ç´¢
    return vectorStoreService.search(queryEmbedding, topK, threshold);
  }

  /**
   * æ·»åŠ æ–‡æ¡£åˆ°çŸ¥è¯†åº“
   */
  async addDocumentsToKnowledge(
    items: Array<{ content: string; metadata: any }>,
    apiKey: string
  ): Promise<void> {
    if (!this.modelScopeService) {
      this.modelScopeService = new ModelScopeService(apiKey);
    }

    // æ‰¹é‡ç”Ÿæˆå‘é‡
    const texts = items.map(item => item.content);
    const embeddings = await this.modelScopeService.generateEmbeddingsBatch(texts);

    // æ·»åŠ åˆ°å‘é‡å­˜å‚¨
    const docs = items.map((item, index) => ({
      content: item.content,
      embedding: embeddings[index],
      metadata: item.metadata
    }));

    vectorStoreService.addDocumentsBatch(docs);
  }

  /**
   * åˆ é™¤æŒ‡å®šæ–‡ä»¶çš„çŸ¥è¯†
   */
  deleteKnowledge(filename: string): number {
    return vectorStoreService.deleteByFilename(filename);
  }
}

export default new RAGService();
```

### å¯¹è¯æœåŠ¡æ•´åˆ

**æ–‡ä»¶ä½ç½®**: `src/server/services/chatService.ts`

```typescript
import type { ChatMessage } from '../../shared/types/index.js';
import type { VectorSearchResult } from '../../shared/types/index.js';
import ragService from './ragService.js';
import ModelScopeService from './modelscopeService.js';

export interface ChatRequest {
  message: string;
  conversationHistory?: Array<{ role: string; content: string | any[] }>;
  modelscopeApiKey: string;
  enableRAG?: boolean;
}

export class ChatService {
  private systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŸå¸‚å±•å…è®²è§£å‘˜ï¼Œåä¸º"åŸå¸‚è®²è§£å‘˜"ã€‚

ä½ çš„èŒè´£ï¼š
1. å‘å‚è§‚è€…ç”ŸåŠ¨è®²è§£åŸå¸‚çš„å†å²æ–‡åŒ–ã€å‘å±•æˆå°±å’Œæœªæ¥è§„åˆ’
2. æ ¹æ®æä¾›çš„çŸ¥è¯†åº“å†…å®¹å›ç­”é—®é¢˜
3. ä¿æŒä¸“ä¸šã€å‹å¥½ã€çƒ­æƒ…çš„æ€åº¦
4. å›ç­”è¦ç®€æ´æ˜äº†ï¼Œå¯Œæœ‰æ„ŸæŸ“åŠ›

é‡è¦åŸåˆ™ï¼š
- ä¼˜å…ˆä½¿ç”¨æä¾›çš„çŸ¥è¯†åº“å†…å®¹å›ç­”
- å¦‚æœçŸ¥è¯†åº“ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥åŸºäºé€šç”¨çŸ¥è¯†å›ç­”
- ä¸ç¡®å®šçš„æƒ…å†µä¸‹æ˜ç¡®è¯´æ˜
- ä¿æŒè®²è§£çš„è¿è´¯æ€§å’Œå¸å¼•åŠ›

è¯·ç”¨ç”ŸåŠ¨æœ‰è¶£çš„è¯­è¨€è¿›è¡Œè®²è§£ï¼Œè®©å‚è§‚è€…ç•™ä¸‹æ·±åˆ»å°è±¡ã€‚`;

  /**
   * æµå¼å¤„ç†å¯¹è¯ï¼ˆå¸¦RAGï¼‰
   */
  async *processChatStream(request: ChatRequest): AsyncGenerator<string | VectorSearchResult[]> {
    const { message, conversationHistory = [], modelscopeApiKey, enableRAG = true } = request;

    // åˆå§‹åŒ–AIæœåŠ¡
    const aiService = new ModelScopeService(modelscopeApiKey);
    ragService.setModelScopeService(aiService);

    // 1. å¦‚æœå¯ç”¨RAGï¼Œæ£€ç´¢ç›¸å…³çŸ¥è¯†
    let sources: VectorSearchResult[] = [];
    if (enableRAG) {
      console.log('[ChatService] å¼€å§‹RAGæ£€ç´¢ï¼Œé—®é¢˜:', message);
      sources = await ragService.retrieveDocuments(message, 5, 0.5);
      console.log('[ChatService] æ£€ç´¢åˆ°çŸ¥è¯†åº“å¼•ç”¨æ•°é‡:', sources.length);
    }

    // 2. æ„å»ºæ¶ˆæ¯åˆ—è¡¨
    const messages: Array<{ role: 'system' | 'user' | 'assistant'; content: string }> = [
      { role: 'system', content: this.systemPrompt }
    ];

    // 3. å¦‚æœæœ‰æ£€ç´¢ç»“æœï¼Œæ·»åŠ åˆ°ä¸Šä¸‹æ–‡
    if (sources.length > 0) {
      let ragContext = '\n\nå‚è€ƒçŸ¥è¯†åº“å†…å®¹ï¼š\n\n';
      sources.forEach((doc, index) => {
        ragContext += `[${index + 1}] ${doc.content}\n`;
        ragContext += `(ç›¸ä¼¼åº¦: ${(doc.score * 100).toFixed(1)}% | æ¥æº: ${doc.metadata.filename})\n\n`;
      });
      messages[0].content += ragContext;
    }

    // 4. æ·»åŠ å¯¹è¯å†å²
    messages.push(...conversationHistory as any);

    // 5. æ·»åŠ å½“å‰é—®é¢˜
    messages.push({ role: 'user', content: message });

    // 6. å…ˆè¿”å›çŸ¥è¯†åº“å¼•ç”¨
    if (sources.length > 0) {
      yield sources;
    }

    // 7. æµå¼ç”Ÿæˆå›å¤
    const stream = aiService.chatStream(messages);

    for await (const chunk of stream) {
      yield chunk;
    }
  }

  /**
   * å›¾ç‰‡ç†è§£å¯¹è¯
   */
  async chatWithImage(imageUrl: string, question: string, apiKey: string): Promise<string> {
    const aiService = new ModelScopeService(apiKey);
    return await aiService.chatWithImage(imageUrl, question);
  }
}

export default new ChatService();
```

### ä¸¤ä¸ªæ¨¡å‹çš„åä½œæµç¨‹

```
ç”¨æˆ·æé—®
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Qwen3-Embedding-8B                     â”‚
â”‚  (å°†é—®é¢˜å‘é‡åŒ–)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢                          â”‚
â”‚  (ä»çŸ¥è¯†åº“å¬å›ç›¸å…³ç‰‡æ®µ)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Qwen3-VL-235B-A22B-Instruct           â”‚
â”‚  (åŸºäºæ£€ç´¢ç»“æœç”Ÿæˆå›ç­”)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®é…ç½®

| é…ç½®é¡¹ | å€¼ |
|-------|-----|
| Base URL | `https://api-inference.modelscope.cn/v1` |
| Embeddingæ¨¡å‹ | `Qwen/Qwen3-Embedding-8B` |
| Chatæ¨¡å‹ | `Qwen/Qwen3-VL-235B-A22B-Instruct` |
| SDK | `openai` (å…¼å®¹åº“) |

---

## æ•°å­—äººæµå¼è¯´è¯ä¸å¯Œæ–‡æœ¬è¾“å‡º

### æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†**æ•°å­—äººå®æ—¶è¯´è¯**ä¸**AIå¯Œæ–‡æœ¬æµå¼è¾“å‡º**çš„å¹¶è¡Œå¤„ç†ï¼Œç¡®ä¿ï¼š
1. AIå›ç­”é€å­—æµå¼æ˜¾ç¤ºï¼Œå¸¦æœ‰æ‰“å­—æœºæ•ˆæœ
2. æ•°å­—äººå®æ—¶åŒæ­¥è®²è§£ï¼Œæ™ºèƒ½åˆ†æ®µè¯´è¯
3. å¯Œæ–‡æœ¬æ ¼å¼æ”¯æŒï¼ˆç²—ä½“ç­‰ï¼‰

### æ•´ä½“æ¶æ„æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ åç«¯AIæµå¼ç”Ÿæˆ â†’ å‰ç«¯SSEæ¥æ”¶ â†’ [UIæ¸²æŸ“ + æ•°å­—äººè¯´è¯å¹¶è¡Œ]
```

### 1. æ•°å­—äººæµå¼è¯´è¯æ§åˆ¶å™¨

**æ–‡ä»¶ä½ç½®**: `src/client/components/Avatar/AvatarController.ts`

```typescript
export type AvatarState =
  | 'offline'
  | 'online'
  | 'idle'
  | 'interactive_idle'
  | 'listen'
  | 'think'
  | 'speak';

export interface SpeakOptions {
  text: string;
  isStart?: boolean;
  isEnd?: boolean;
}

export class AvatarController {
  private sdk: any = null;
  private config: AvatarConfig;
  private isOnline: boolean = false;

  /**
   * æµå¼è¯´è¯ - å®æ—¶é€æ®µè¯´è¯
   * @param text æ–‡æœ¬ç‰‡æ®µ
   * @param isStart æ˜¯å¦å¼€å§‹æ ‡è®°
   * @param isEnd æ˜¯å¦ç»“æŸæ ‡è®°
   */
  speakStream(text: string, isStart: boolean = false, isEnd: boolean = false): void {
    if (!this.checkOnline()) return;
    // è°ƒç”¨SDKçš„speakæ–¹æ³•
    this.sdk?.speak(text, isStart, isEnd);
  }

  /**
   * ç»“æŸæµå¼è¯´è¯
   */
  endStream(): void {
    if (!this.checkOnline()) return;
    // å‘é€ç©ºå†…å®¹æ ‡è®°ç»“æŸ
    this.speak({ text: '', isStart: false, isEnd: true });
  }

  /**
   * æ£€æŸ¥SDKæ˜¯å¦åœ¨çº¿
   */
  private checkOnline(): boolean {
    if (!this.sdk) {
      console.error('[Avatar] SDK not initialized');
      return false;
    }
    if (!this.isOnline) {
      console.warn('[Avatar] SDK is not online yet, ignoring command');
      return false;
    }
    return true;
  }
}

export default AvatarController;
```

### 2. å‰ç«¯SSEæµå¼è¯·æ±‚æœåŠ¡

**æ–‡ä»¶ä½ç½®**: `src/client/services/chatService.ts`

```typescript
import axios from 'axios';

const API_BASE = '/api';

export interface ChatRequest {
  message: string;
  conversationHistory?: Array<{ role: string; content: string }>;
  modelscopeApiKey: string;
  enableRAG?: boolean;
}

/**
 * æµå¼å‘é€å¯¹è¯æ¶ˆæ¯ï¼ˆSSEï¼‰
 */
export async function sendMessageStream(
  request: ChatRequest,
  onChunk: (chunk: string) => void,      // æ¯æ”¶åˆ°ä¸€ä¸ªæ–‡æœ¬å—è§¦å‘
  onComplete: (sources?: any[]) => void,  // å®Œæˆæ—¶è§¦å‘
  onError: (error: string) => void        // é”™è¯¯æ—¶è§¦å‘
): Promise<void> {
  try {
    const response = await fetch(`${API_BASE}/chat/stream`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(request)
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const reader = response.body?.getReader();
    if (!reader) {
      throw new Error('æ— æ³•è¯»å–å“åº”æµ');
    }

    const decoder = new TextDecoder();
    let buffer = '';
    let sources: any[] = [];

    while (true) {
      const { done, value } = await reader.read();

      if (done) {
        onComplete(sources.length > 0 ? sources : undefined);
        break;
      }

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (line.trim() && line.startsWith('data: ')) {
          const data = line.slice(6);
          try {
            const parsed = JSON.parse(data);

            if (parsed.type === 'content') {
              onChunk(parsed.data);
            } else if (parsed.type === 'sources') {
              sources = parsed.data;
            } else if (parsed.type === 'end') {
              onComplete(sources.length > 0 ? sources : undefined);
              return;
            } else if (parsed.type === 'error') {
              onError(parsed.data);
              return;
            }
          } catch (e) {
            // å¿½ç•¥è§£æé”™è¯¯
          }
        }
      }
    }
  } catch (error: any) {
    onError(error.message || 'æµå¼è¯·æ±‚å¤±è´¥');
  }
}

export default {
  sendMessageStream,
  chatWithImage
};
```

### 3. èŠå¤©çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼‰

**æ–‡ä»¶ä½ç½®**: `src/client/store/chatStore.ts`

```typescript
import { create } from 'zustand';
import type { Message } from '../types/index.js';

interface ChatState {
  messages: Message[];        // å†å²æ¶ˆæ¯
  currentResponse: string;    // å½“å‰æµå¼å“åº”ï¼ˆç´¯ç§¯ï¼‰
  currentSources: any[];      // å½“å‰çŸ¥è¯†åº“å¼•ç”¨
  isProcessing: boolean;

  appendCurrentResponse: (text: string) => void;  // è¿½åŠ æ–‡æœ¬å—
  setCurrentResponse: (response: string) => void; // è®¾ç½®å“åº”
  setCurrentSources: (sources: any[]) => void;
  addMessage: (message: Message) => void;
  setProcessing: (processing: boolean) => void;
  clearMessages: () => void;
  getConversationHistory: () => Array<{ role: string; content: string }>;
}

export const useChatStore = create<ChatState>()((set, get) => ({
  messages: [],
  isProcessing: false,
  currentResponse: '',
  currentSources: [],

  // è¿½åŠ æµå¼æ–‡æœ¬å—
  appendCurrentResponse: (text) =>
    set((state) => ({
      currentResponse: state.currentResponse + text
    })),

  setCurrentResponse: (response) =>
    set({ currentResponse: response }),

  setCurrentSources: (sources) =>
    set({ currentSources: sources }),

  addMessage: (message) =>
    set((state) => ({
      messages: [...state.messages, message]
    })),

  setProcessing: (processing) =>
    set({ isProcessing: processing }),

  clearMessages: () =>
    set({ messages: [], currentResponse: '', currentSources: [] }),

  getConversationHistory: () => {
    return get().messages.map(m => ({
      role: m.role,
      content: m.content
    }));
  }
}));
```

### 4. å¯Œæ–‡æœ¬æ¶ˆæ¯å±•ç¤ºç»„ä»¶

**æ–‡ä»¶ä½ç½®**: `src/client/components/Chat/MessageList.tsx`

```typescript
import React from 'react';
import type { Message } from '../../store/chatStore';
import { KnowledgeSources } from './KnowledgeSources';

interface MessageListProps {
  messages: Message[];
  currentResponse: string;
  isProcessing: boolean;
}

export const MessageList: React.FC<MessageListProps> = ({
  messages,
  currentResponse,
  isProcessing
}) => {
  const messagesEndRef = React.useRef<HTMLDivElement>(null);

  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  React.useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, currentResponse]);

  /**
   * å¯Œæ–‡æœ¬æ ¼å¼åŒ– - æ”¯æŒ**ç²—ä½“**ç­‰æ ‡è®°
   */
  const formatContent = (content: string) => {
    return content
      .split('\n')
      .map((line, i) => {
        // å°† **æ–‡æœ¬** è½¬æ¢ä¸º <strong>æ ‡ç­¾
        line = line.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        return (
          <p key={i} dangerouslySetInnerHTML={{ __html: line || '&nbsp;' }} />
        );
      });
  };

  return (
    <div className="h-full p-6 space-y-4 custom-scrollbar overflow-y-auto">
      {/* å†å²æ¶ˆæ¯ */}
      {messages.map((message) => (
        <div
          key={message.id}
          className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
        >
          <div className={`flex flex-col max-w-[85%]`}>
            <div className={`flex items-end space-x-4`}>
              {/* å¤´åƒ */}
              {message.role === 'assistant' ? (
                <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-400 to-cyan-400 flex-shrink-0 flex items-center justify-center text-white text-xl font-bold shadow-lg">
                  ğŸ¤–
                </div>
              ) : (
                <div className="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur-sm flex-shrink-0 flex items-center justify-center text-white text-xl border border-white/30">
                  ğŸ‘¤
                </div>
              )}

              {/* æ¶ˆæ¯æ°”æ³¡ */}
              <div className={`px-6 py-4 message-bubble ${
                message.role === 'user'
                  ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-3xl rounded-br-lg shadow-lg'
                  : 'bg-white/10 backdrop-blur-sm text-white rounded-3xl rounded-bl-lg border border-white/20'
              }`}>
                <div className="text-lg leading-relaxed whitespace-pre-wrap">
                  {formatContent(message.content)}
                </div>
              </div>
            </div>

            {/* çŸ¥è¯†åº“å¼•ç”¨ */}
            {message.sources && message.sources.length > 0 && (
              <KnowledgeSources sources={message.sources} />
            )}
          </div>
        </div>
      ))}

      {/* å½“å‰æµå¼å“åº” + æ‰“å­—æœºå…‰æ ‡åŠ¨ç”» */}
      {currentResponse && (
        <div className="flex justify-start">
          <div className="flex space-x-4 max-w-[80%]">
            <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-400 to-cyan-400 flex-shrink-0 flex items-center justify-center text-white text-xl font-bold shadow-lg">
              ğŸ¤–
            </div>
            <div className="px-6 py-4 bg-white/10 backdrop-blur-sm text-white rounded-3xl rounded-bl-lg border border-white/20">
              <div className="text-lg leading-relaxed whitespace-pre-wrap">
                {formatContent(currentResponse)}
                {/* é—ªçƒå…‰æ ‡ */}
                <span className="inline-block w-1 h-5 bg-cyan-400 animate-pulse ml-1 align-middle" />
              </div>
            </div>
          </div>
        </div>
      )}

      {/* åŠ è½½åŠ¨ç”» */}
      {isProcessing && !currentResponse && (
        <div className="flex justify-start">
          <div className="flex space-x-4">
            <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-400 to-cyan-400 flex-shrink-0 flex items-center justify-center text-white text-xl font-bold shadow-lg">
              ğŸ¤–
            </div>
            <div className="px-6 py-4 bg-white/10 backdrop-blur-sm rounded-2xl border border-white/20">
              <div className="flex space-x-2">
                <div className="w-3 h-3 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
                <div className="w-3 h-3 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
                <div className="w-3 h-3 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
              </div>
            </div>
          </div>
        </div>
      )}

      <div ref={messagesEndRef} />
    </div>
  );
};

export default MessageList;
```

### 5. æ ¸å¿ƒæ•´åˆé€»è¾‘ï¼šUI + æ•°å­—äººå¹¶è¡Œ

**æ–‡ä»¶ä½ç½®**: `src/client/App.tsx`ï¼ˆå…³é”®éƒ¨åˆ†ï¼‰

```typescript
import React, { useState } from 'react';
import { useChatStore } from './store/chatStore';
import type { AvatarController } from './components/Avatar/AvatarController';
import chatService from './services/chatService';
import storageService from './services/storageService';

function App() {
  const controllerRef = React.useRef<AvatarController | null>(null);

  const {
    messages,
    addMessage,
    setProcessing,
    currentResponse,
    setCurrentResponse,
    appendCurrentResponse,
    setCurrentSources,
    getConversationHistory,
    isProcessing
  } = useChatStore();

  /**
   * å‘é€æ¶ˆæ¯ - æ ¸å¿ƒæ•´åˆé€»è¾‘
   */
  const handleSendMessage = async (text: string) => {
    console.log('[App] handleSendMessage è¢«è°ƒç”¨:', text);

    // 1. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage({
      id: Date.now().toString(),
      role: 'user',
      content: text,
      timestamp: Date.now()
    });

    setProcessing(true);
    setCurrentResponse('');
    setCurrentSources([]);

    const history = getConversationHistory();
    const apiKey = storageService.getModelScopeKey();

    // æµå¼è¯´è¯çŠ¶æ€è¿½è¸ª
    let isFirstChunk = true;       // æ ‡è®°æ˜¯å¦ç¬¬ä¸€æ®µ
    let speakingBuffer = '';        // æ•°å­—äººè¯´è¯ç¼“å†²åŒº

    try {
      await chatService.sendMessageStream(
        {
          message: text,
          conversationHistory: history,
          modelscopeApiKey: apiKey
        },

        // ==================== onChunk: æ¯æ”¶åˆ°æ–‡æœ¬å— ====================
        (chunk: string) => {
          console.log('[App] æ”¶åˆ°æµå¼å†…å®¹:', chunk);

          // 1. æ›´æ–°UIæ˜¾ç¤º
          appendCurrentResponse(chunk);

          // 2. æ•°å­—äººè¯´è¯ - æ™ºèƒ½åˆ†æ®µç­–ç•¥
          if (controllerRef.current) {
            speakingBuffer += chunk;

            // åˆ†æ®µæ¡ä»¶ï¼š
            // - ç´¯ç§¯é•¿åº¦ >= 10 å­—ç¬¦
            // - æˆ–é‡åˆ°æ ‡ç‚¹ç¬¦å·
            if (speakingBuffer.length >= 10 || /[ã€‚ï¼ï¼Ÿï¼Œã€ï¼›ï¼š.!?,:;]/.test(chunk)) {
              controllerRef.current.speakStream(
                speakingBuffer,      // æ–‡æœ¬ç‰‡æ®µ
                isFirstChunk,        // é¦–æ®µæ ‡è®°
                false                // éç»“æŸ
              );
              speakingBuffer = '';
              isFirstChunk = false;
            }
          }
        },

        // ==================== onComplete: æµå¼å®Œæˆ ====================
        (sources?: any[]) => {
          console.log('[App] æµå¼å¯¹è¯å®Œæˆ');

          // è½¬æ¢çŸ¥è¯†åº“å¼•ç”¨æ ¼å¼
          const transformedSources = sources?.map((item: any) => ({
            content: item.content,
            score: item.score,
            filename: item.metadata?.filename || item.filename
          }));

          // å‘é€å‰©ä½™å†…å®¹ç»™æ•°å­—äºº
          if (controllerRef.current && speakingBuffer) {
            controllerRef.current.speakStream(speakingBuffer, isFirstChunk, true);
            speakingBuffer = '';
          } else if (controllerRef.current) {
            controllerRef.current.endStream();
          }

          // ä¿å­˜åˆ°å†å²æ¶ˆæ¯
          const finalResponse = useChatStore.getState().currentResponse;
          addMessage({
            id: (Date.now() + 1).toString(),
            role: 'assistant',
            content: finalResponse,
            timestamp: Date.now(),
            sources: transformedSources
          });

          setCurrentResponse('');
          setCurrentSources([]);
          setProcessing(false);
        },

        // ==================== onError: é”™è¯¯å¤„ç† ====================
        (error: string) => {
          console.error('[App] æµå¼å¯¹è¯é”™è¯¯:', error);
          addMessage({
            id: (Date.now() + 1).toString(),
            role: 'assistant',
            content: `æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼š${error}`,
            timestamp: Date.now()
          });
          setCurrentResponse('');
          setCurrentSources([]);
          setProcessing(false);
        }
      );
    } catch (error: any) {
      console.error('[App] handleSendMessage å¼‚å¸¸:', error);
      addMessage({
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: `å‘é€æ¶ˆæ¯å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`,
        timestamp: Date.now()
      });
      setProcessing(false);
    }
  };

  return (
    <div className="h-screen w-screen overflow-hidden bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <header>...</header>

      {/* ä¸»å†…å®¹åŒº */}
      <main className="flex gap-6">
        {/* å·¦ä¾§ï¼šæ•°å­—äººåŒºåŸŸ */}
        <div className="w-[45%]">
          <AvatarContainer
            controllerRef={controllerRef}
            onSpeakingStart={() => console.log('å¼€å§‹è¯´è¯')}
            onSpeakingEnd={() => console.log('ç»“æŸè¯´è¯')}
          />
        </div>

        {/* å³ä¾§ï¼šå¯¹è¯åŒºåŸŸ */}
        <div className="w-[55%] flex flex-col">
          <MessageList
            messages={messages}
            currentResponse={currentResponse}
            isProcessing={isProcessing}
          />
          <ChatInput
            onSend={handleSendMessage}
            disabled={isProcessing}
          />
        </div>
      </main>
    </div>
  );
}

export default App;
```

### æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    handleSendMessage                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              chatService.sendMessageStream                  â”‚
â”‚         (SSEæµå¼æ¥æ”¶åç«¯AIå“åº”)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   onChunk å›è°ƒ          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚
         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UIæ›´æ–°           â”‚    â”‚ æ•°å­—äººè¯´è¯       â”‚
â”‚ appendCurrent   â”‚    â”‚ speakStream()    â”‚
â”‚ Response(chunk) â”‚    â”‚ æ™ºèƒ½åˆ†æ®µå‘é€     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   onComplete           â”‚
         â”‚   - ä¿å­˜æ¶ˆæ¯åˆ°å†å²      â”‚
         â”‚   - æ•°å­—äººç»“æŸæµ       â”‚
         â”‚   - æ¸…ç†çŠ¶æ€           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŠ€æœ¯ç‚¹æ€»ç»“

| æŠ€æœ¯ | å®ç°æ–¹å¼ |
|------|---------|
| **SSEæµå¼æ¥æ”¶** | `fetch` + `ReadableStream` + `TextDecoder` |
| **å¯Œæ–‡æœ¬æ¸²æŸ“** | `dangerouslySetInnerHTML` + æ­£åˆ™æ›¿æ¢ `**bold**` |
| **æ‰“å­—æœºæ•ˆæœ** | å®æ—¶ç´¯ç§¯ + å…‰æ ‡ `animate-pulse` |
| **æ•°å­—äººæµå¼è¯´è¯** | ç¼“å†²åŒºç§¯ç´¯åˆ°æ ‡ç‚¹/é•¿åº¦è§¦å‘ |
| **å¹¶è¡Œå¤„ç†** | UIæ›´æ–°å’Œæ•°å­—äººè¯´è¯åœ¨åŒä¸€å›è°ƒä¸­è§¦å‘ |
| **çŸ¥è¯†åº“å¼•ç”¨** | `sources` æ•°æ®éšæ¶ˆæ¯å…³è”å±•ç¤º |

---

## çŸ¥è¯†åº“ç®¡ç†

### 1. çŸ¥è¯†åº“ä¸Šä¼ ç»„ä»¶

**KnowledgeUploader.tsx**
```typescript
import React, { useState } from 'react';
import { useDropzone } from 'react-dropzone';

export const KnowledgeUploader: React.FC<{ onUpload: (files: File[]) => void }> = ({ onUpload }) => {
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState(0);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    accept: {
      'text/plain': ['.txt'],
      'text/markdown': ['.md'],
      'application/pdf': ['.pdf'],
      'application/json': ['.json']
    },
    multiple: true,
    onDrop: async (acceptedFiles) => {
      setUploading(true);
      setProgress(0);

      try {
        await onUpload(acceptedFiles);
        setProgress(100);
      } catch (error) {
        alert('ä¸Šä¼ å¤±è´¥: ' + error);
      } finally {
        setUploading(false);
        setProgress(0);
      }
    }
  });

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      <h3 className="text-lg font-semibold mb-4">ä¸Šä¼ çŸ¥è¯†åº“</h3>

      <div
        {...getRootProps()}
        className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${
          isDragActive
            ? 'border-blue-500 bg-blue-50'
            : 'border-gray-300 hover:border-gray-400'
        }`}
      >
        <input {...getInputProps()} />
        <div className="text-4xl mb-3">ğŸ“</div>
        {isDragActive ? (
          <p className="text-blue-600">é‡Šæ”¾æ–‡ä»¶ä»¥å¼€å§‹ä¸Šä¼ ...</p>
        ) : (
          <div>
            <p className="text-gray-700 font-medium">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
            <p className="text-sm text-gray-500 mt-2">æ”¯æŒ TXT, MD, PDF, JSON æ ¼å¼</p>
          </div>
        )}
      </div>

      {uploading && (
        <div className="mt-4">
          <div className="flex justify-between text-sm text-gray-600 mb-1">
            <span>å¤„ç†ä¸­...</span>
            <span>{progress}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div
              className="bg-blue-500 h-2 rounded-full transition-all"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>
      )}

      <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
        <p className="text-sm text-yellow-800">
          ğŸ’¡ æç¤ºï¼šä¸Šä¼ çš„æ–‡ä»¶å°†è¢«è‡ªåŠ¨åˆ†å—å¹¶å‘é‡åŒ–ï¼Œç”¨äºæ™ºèƒ½æ£€ç´¢å›ç­”ã€‚
        </p>
      </div>
    </div>
  );
};
```

### 2. çŸ¥è¯†åº“åˆ—è¡¨ç»„ä»¶

**KnowledgeList.tsx**
```typescript
import React, { useEffect, useState } from 'react';
import axios from 'axios';

interface KnowledgeFile {
  filename: string;
  uploadTime: number;
  chunkCount: number;
}

export const KnowledgeList: React.FC = () => {
  const [files, setFiles] = useState<KnowledgeFile[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadFiles();
  }, []);

  const loadFiles = async () => {
    try {
      const response = await axios.get('/api/knowledge/list');
      setFiles(response.data.files);
    } catch (error) {
      console.error('åŠ è½½å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (filename: string) => {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${filename} å—ï¼Ÿ`)) return;

    try {
      await axios.delete('/api/knowledge/file', { data: { filename } });
      setFiles(files.filter(f => f.filename !== filename));
    } catch (error) {
      alert('åˆ é™¤å¤±è´¥');
    }
  };

  const handleClearAll = async () => {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çŸ¥è¯†åº“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

    try {
      await axios.delete('/api/knowledge/all');
      setFiles([]);
    } catch (error) {
      alert('æ¸…ç©ºå¤±è´¥');
    }
  };

  if (loading) {
    return <div className="text-center py-8">åŠ è½½ä¸­...</div>;
  }

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-semibold">çŸ¥è¯†åº“æ–‡ä»¶</h3>
        {files.length > 0 && (
          <button
            onClick={handleClearAll}
            className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm"
          >
            æ¸…ç©ºå…¨éƒ¨
          </button>
        )}
      </div>

      {files.length === 0 ? (
        <div className="text-center py-8 text-gray-500">
          è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•çŸ¥è¯†åº“æ–‡ä»¶
        </div>
      ) : (
        <div className="space-y-2">
          {files.map((file, index) => (
            <div
              key={index}
              className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
            >
              <div className="flex-1">
                <div className="font-medium text-gray-800">{file.filename}</div>
                <div className="text-sm text-gray-500">
                  {file.chunkCount} ä¸ªç‰‡æ®µ Â· {new Date(file.uploadTime).toLocaleString()}
                </div>
              </div>
              <button
                onClick={() => handleDelete(file.filename)}
                className="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm"
              >
                åˆ é™¤
              </button>
            </div>
          ))}
        </div>
      )}

      <div className="mt-4 p-4 bg-blue-50 rounded-lg">
        <div className="text-sm text-blue-800">
          <strong>å‘é‡æ£€ç´¢è¯´æ˜ï¼š</strong>
          <ul className="list-disc list-inside mt-2 space-y-1">
            <li>ä¸Šä¼ çš„æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ†å—å¹¶å‘é‡åŒ–</li>
            <li>ç”¨æˆ·æé—®æ—¶ä¼šæ£€ç´¢æœ€ç›¸å…³çš„çŸ¥è¯†ç‰‡æ®µ</li>
            <li>æ£€ç´¢ç»“æœä¼šèå…¥AIå›ç­”ä¸­</li>
          </ul>
        </div>
      </div>
    </div>
  );
};
```

---

## å‘é‡æ£€ç´¢ç³»ç»Ÿ

### 1. å¯¹è¯æœåŠ¡é›†æˆRAG

**chatService.tsï¼ˆåç«¯ï¼‰**
```typescript
import ModelScopeService from './modelscopeService';
import ragService from './ragService';

export interface ChatRequest {
  message: string;
  conversationHistory?: Array<{ role: string; content: string | any[] }>;
  modelscopeApiKey: string;
  enableRAG?: boolean;
}

export class ChatService {
  private systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŸå¸‚å±•å…è®²è§£å‘˜ï¼Œåä¸º"åŸå¸‚è®²è§£å‘˜"ã€‚

ä½ çš„èŒè´£ï¼š
1. å‘å‚è§‚è€…ç”ŸåŠ¨è®²è§£åŸå¸‚çš„å†å²æ–‡åŒ–ã€å‘å±•æˆå°±å’Œæœªæ¥è§„åˆ’
2. æ ¹æ®æä¾›çš„çŸ¥è¯†åº“å†…å®¹å›ç­”é—®é¢˜
3. ä¿æŒä¸“ä¸šã€å‹å¥½ã€çƒ­æƒ…çš„æ€åº¦
4. å›ç­”è¦ç®€æ´æ˜äº†ï¼Œå¯Œæœ‰æ„ŸæŸ“åŠ›

é‡è¦åŸåˆ™ï¼š
- ä¼˜å…ˆä½¿ç”¨æä¾›çš„çŸ¥è¯†åº“å†…å®¹å›ç­”
- å¦‚æœçŸ¥è¯†åº“ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥åŸºäºé€šç”¨çŸ¥è¯†å›ç­”
- ä¸ç¡®å®šçš„æƒ…å†µä¸‹æ˜ç¡®è¯´æ˜
- ä¿æŒè®²è§£çš„è¿è´¯æ€§å’Œå¸å¼•åŠ›

è¯·ç”¨ç”ŸåŠ¨æœ‰è¶£çš„è¯­è¨€è¿›è¡Œè®²è§£ï¼Œè®©å‚è§‚è€…ç•™ä¸‹æ·±åˆ»å°è±¡ã€‚`;

  /**
   * æµå¼å¤„ç†å¯¹è¯ï¼ˆå¸¦RAGï¼‰
   */
  async *processChatStream(request: ChatRequest): AsyncGenerator<string> {
    const { message, conversationHistory = [], modelscopeApiKey, enableRAG = true } = request;

    // åˆå§‹åŒ–AIæœåŠ¡
    const aiService = new ModelScopeService(modelscopeApiKey);
    ragService.setModelScopeService(aiService);

    // 1. æ„å»ºæ¶ˆæ¯åˆ—è¡¨
    const messages: Array<{ role: 'system' | 'user' | 'assistant'; content: string }> = [
      { role: 'system', content: this.systemPrompt }
    ];

    // 2. å¦‚æœå¯ç”¨RAGï¼Œæ£€ç´¢ç›¸å…³çŸ¥è¯†
    if (enableRAG) {
      const ragContext = await ragService.buildRAGContext(message);
      if (ragContext) {
        messages[0].content += `\n\n${ragContext}`;
      }
    }

    // 3. æ·»åŠ å¯¹è¯å†å²
    messages.push(...conversationHistory as any);

    // 4. æ·»åŠ å½“å‰é—®é¢˜
    messages.push({ role: 'user', content: message });

    // 5. æµå¼ç”Ÿæˆå›å¤
    const stream = aiService.chatStream(messages);

    for await (const chunk of stream) {
      yield chunk;
    }
  }

  /**
   * å›¾ç‰‡ç†è§£å¯¹è¯
   */
  async chatWithImage(imageUrl: string, question: string, apiKey: string): Promise<string> {
    const aiService = new ModelScopeService(apiKey);
    return await aiService.chatWithImage(imageUrl, question);
  }
}

export default new ChatService();
```

---

## å¤§å±äº¤äº’è®¾è®¡

### å¤§å±å¸ƒå±€è§„èŒƒ

**è®¾è®¡åˆ†è¾¨ç‡ï¼š1920x1080ï¼ˆFHDï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡¶éƒ¨å¯¼èˆªæ  (80px)                                                           â”‚
â”‚  Logo | æ ‡é¢˜ | æ–°å¯¹è¯æŒ‰é’® | å¯†é’¥é…ç½®                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚   æ•°å­—äººå±•ç¤ºåŒº           â”‚  â”‚   å¯¹è¯äº¤äº’åŒº                               â”‚ â”‚
â”‚  â”‚   (50% å®½åº¦)            â”‚  â”‚   (50% å®½åº¦)                              â”‚ â”‚
â”‚  â”‚                         â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                   â”‚ â”‚  â”‚  â”‚  æ¶ˆæ¯åˆ—è¡¨ (å¯æ»šåŠ¨)                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3Dæ•°å­—äºº         â”‚ â”‚  â”‚  â”‚                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                   â”‚ â”‚  â”‚  â”‚  - ç”¨æˆ·æ¶ˆæ¯                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                   â”‚ â”‚  â”‚  â”‚  - AIå›å¤ (å¸¦çŸ¥è¯†æ¥æº)                â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚  - å½“å‰è¾“å…¥çŠ¶æ€                       â”‚ â”‚ â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚                                      â”‚ â”‚ â”‚
â”‚  â”‚  [çŠ¶æ€æŒ‡ç¤ºå™¨]           â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  [éŸ³é‡æ§åˆ¶]             â”‚  â”‚                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                               â”‚  â”‚  å¿«æ·æé—®é¢æ¿                         â”‚ â”‚ â”‚
â”‚                               â”‚  â”‚  [åŸå¸‚å†å²] [æœªæ¥è§„åˆ’] [æ–‡åŒ–æ™¯ç‚¹]     â”‚ â”‚ â”‚
â”‚                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                               â”‚                                           â”‚ â”‚
â”‚                               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                               â”‚  â”‚  è¾“å…¥åŒºåŸŸ                             â”‚ â”‚ â”‚
â”‚                               â”‚  â”‚  [è¾“å…¥æ¡†] [è¯­éŸ³] [å‘é€]               â”‚ â”‚ â”‚
â”‚                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¤§å±æ ·å¼è§„èŒƒ

```css
/* å¤§å±åŸºç¡€æ ·å¼ */
:root {
  /* å­—ä½“å¤§å° - å¤§å±é€‚é… */
  --font-size-base: 18px;
  --font-size-lg: 20px;
  --font-size-xl: 24px;
  --font-size-2xl: 32px;

  /* é—´è· */
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;

  /* è§¦æ§åŒºåŸŸæœ€å°å°ºå¯¸ */
  --touch-target-min: 48px;
}

/* è§¦æ§ä¼˜åŒ– */
.touch-button {
  min-height: var(--touch-target-min);
  min-width: var(--touch-target-min);
  padding: 12px 24px;
}

/* å¤§å±è¾“å…¥æ¡† */
.lg-input {
  font-size: var(--font-size-lg);
  padding: 16px 20px;
  min-height: 56px;
}

/* æ¶ˆæ¯æ°”æ³¡ */
.message-bubble {
  font-size: var(--font-size-base);
  padding: 16px 20px;
  max-width: 70%;
}
```

### è§¦æ§äº¤äº’è§„èŒƒ

| äº¤äº’å…ƒç´  | æœ€å°å°ºå¯¸ | é—´è· | åé¦ˆ |
|---------|---------|------|------|
| æŒ‰é’® | 48x48px | 8px | è§†è§‰+è§¦è§‰ |
| è¾“å…¥æ¡† | é«˜åº¦56px | 16px | èšç„¦è¾¹æ¡† |
| åˆ—è¡¨é¡¹ | é«˜åº¦64px | 0px | ç‚¹å‡»é«˜äº® |
| å¿«æ·æ“ä½œ | 64x64px | 16px | ç‚¹å‡»ç¼©æ”¾ |

---

## Widgetå±•ç¤ºåŠŸèƒ½

### Widgetäº‹ä»¶å¤„ç†

SDKæ”¯æŒé€šè¿‡Widgetäº‹ä»¶å±•ç¤ºå›¾ç‰‡å’Œè§†é¢‘å†…å®¹ã€‚å½“AIå›ç­”ä¸­åŒ…å«ç‰¹å®šæ ‡è®°æ—¶ï¼Œè§¦å‘Widgetå±•ç¤ºã€‚

**AvatarController.ts - Widgetå¤„ç†**
```typescript
export class AvatarController {
  // ... å…¶ä»–ä»£ç 

  /**
   * å¤„ç†å›¾ç‰‡Widget
   */
  private handleImageWidget(data: any): void {
    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œè®©Reactç»„ä»¶ç›‘å¬
    window.dispatchEvent(new CustomEvent('avatar:image-widget', {
      detail: {
        url: data.url,
        title: data.title,
        description: data.description
      }
    }));
  }

  /**
   * å¤„ç†è½®æ’­å›¾Widget
   */
  private handleSlideshowWidget(data: any): void {
    window.dispatchEvent(new CustomEvent('avatar:slideshow-widget', {
      detail: {
        images: data.images,
        autoplay: data.autoplay || false,
        interval: data.interval || 3000
      }
    }));
  }

  /**
   * å¤„ç†è§†é¢‘Widget
   */
  private handleVideoWidget(data: any): void {
    window.dispatchEvent(new CustomEvent('avatar:video-widget', {
      detail: {
        url: data.url,
        poster: data.poster,
        autoplay: data.autoplay || true
      }
    }));
  }
}
```

### å›¾ç‰‡Widgetç»„ä»¶

**ImageWidget.tsx**
```typescript
import React, { useEffect, useState } from 'react';

interface WidgetData {
  url: string;
  title?: string;
  description?: string;
}

export const ImageWidget: React.FC = () => {
  const [widget, setWidget] = useState<WidgetData | null>(null);
  const [visible, setVisible] = useState(false);

  useEffect(() => {
    const handler = (event: CustomEvent<WidgetData>) => {
      setWidget(event.detail);
      setVisible(true);

      // 5ç§’åè‡ªåŠ¨å…³é—­
      setTimeout(() => {
        setVisible(false);
      }, 5000);
    };

    window.addEventListener('avatar:image-widget', handler as EventListener);
    return () => {
      window.removeEventListener('avatar:image-widget', handler as EventListener);
    };
  }, []);

  if (!visible || !widget) return null;

  return (
    <div className="fixed top-1/2 right-8 transform -translate-y-1/2 bg-white rounded-xl shadow-2xl p-4 max-w-md animate-fade-in">
      <img src={widget.url} alt={widget.title} className="w-full rounded-lg" />
      {widget.title && (
        <h3 className="text-lg font-semibold mt-3">{widget.title}</h3>
      )}
      {widget.description && (
        <p className="text-sm text-gray-600 mt-1">{widget.description}</p>
      )}
    </div>
  );
};
```

### è§†é¢‘Widgetç»„ä»¶

**VideoWidget.tsx**
```typescript
import React, { useEffect, useState } from 'react';

interface VideoWidgetData {
  url: string;
  poster?: string;
  autoplay?: boolean;
}

export const VideoWidget: React.FC = () => {
  const [widget, setWidget] = useState<VideoWidgetData | null>(null);
  const [visible, setVisible] = useState(false);

  useEffect(() => {
    const handler = (event: CustomEvent<VideoWidgetData>) => {
      setWidget(event.detail);
      setVisible(true);
    };

    window.addEventListener('avatar:video-widget', handler as EventListener);
    return () => {
      window.removeEventListener('avatar:video-widget', handler as EventListener);
    };
  }, []);

  const handleClose = () => {
    setVisible(false);
  };

  if (!visible || !widget) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-xl shadow-2xl p-4 max-w-3xl w-full mx-4">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-semibold">è§†é¢‘å±•ç¤º</h3>
          <button onClick={handleClose} className="text-gray-500 hover:text-gray-700">
            âœ•
          </button>
        </div>
        <video
          src={widget.url}
          poster={widget.poster}
          autoPlay={widget.autoplay}
          controls
          className="w-full rounded-lg"
        />
      </div>
    </div>
  );
};
```

---

## å¯†é’¥ç®¡ç†

### å†…ç½®æµ‹è¯•å¯†é’¥è¯´æ˜

**æµ‹è¯•å¯†é’¥ä¿¡æ¯**
```typescript
// é­”æ­ç¤¾åŒºæµ‹è¯•å¯†é’¥
const TEST_MODELSCOPE_KEY = 'ms-de3c153b-5a19-41d1-bd3e-257a7eef7922';

/**
 * æµ‹è¯•å¯†é’¥ä½¿ç”¨è¯´æ˜
 *
 * 1. æ­¤å¯†é’¥ä¸ºé¡¹ç›®å†…ç½®æµ‹è¯•å¯†é’¥ï¼Œä¾›å¿«é€Ÿä½“éªŒå’Œæ¼”ç¤ºä½¿ç”¨
 * 2. æµ‹è¯•å¯†é’¥å¯èƒ½æœ‰ä»¥ä¸‹é™åˆ¶ï¼š
 *    - è¯·æ±‚é¢‘ç‡é™åˆ¶ (QPS)
 *    - æ¯æ—¥Tokenä½¿ç”¨é™é¢
 *    - å¯èƒ½éšæ—¶å¤±æ•ˆ
 * 3. ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨æ‚¨è‡ªå·±çš„é­”æ­ç¤¾åŒºAPIå¯†é’¥
 * 4. è·å–å¯†é’¥ï¼šhttps://modelscope.cn/my/myaccesstoken
 */
```

### å¯†é’¥å­˜å‚¨æœåŠ¡

**storageService.ts**
```typescript
const STORAGE_KEYS = {
  MODELSCOPE_API_KEY: 'city_guide_modelscope_key',
  AVATAR_APP_ID: 'city_guide_avatar_app_id',
  AVATAR_SECRET: 'city_guide_avatar_secret',
  USE_TEST_KEY: 'city_guide_use_test_key'
};

// å†…ç½®æµ‹è¯•å¯†é’¥
export const TEST_KEYS = {
  modelscope: 'ms-de3c153b-5a19-41d1-bd3e-257a7eef7922',
  avatarAppId: '', // éœ€è¦ç”¨æˆ·æä¾›
  avatarSecret: '' // éœ€è¦ç”¨æˆ·æä¾›
};

export class StorageService {
  /**
   * è·å–é­”æ­APIå¯†é’¥
   */
  getModelScopeKey(): string {
    const useTest = localStorage.getItem(STORAGE_KEYS.USE_TEST_KEY);
    if (useTest === 'true') {
      return TEST_KEYS.modelscope;
    }
    return localStorage.getItem(STORAGE_KEYS.MODELSCOPE_API_KEY) || TEST_KEYS.modelscope;
  }

  /**
   * ä¿å­˜é­”æ­APIå¯†é’¥
   */
  setModelScopeKey(key: string): void {
    localStorage.setItem(STORAGE_KEYS.MODELSCOPE_API_KEY, key);
    localStorage.setItem(STORAGE_KEYS.USE_TEST_KEY, 'false');
  }

  /**
   * è·å–æ•°å­—äººå¯†é’¥
   */
  getAvatarKeys(): { appId: string; secret: string } {
    return {
      appId: localStorage.getItem(STORAGE_KEYS.AVATAR_APP_ID) || '',
      secret: localStorage.getItem(STORAGE_KEYS.AVATAR_SECRET) || ''
    };
  }

  /**
   * ä¿å­˜æ•°å­—äººå¯†é’¥
   */
  setAvatarKeys(appId: string, secret: string): void {
    localStorage.setItem(STORAGE_KEYS.AVATAR_APP_ID, appId);
    localStorage.setItem(STORAGE_KEYS.AVATAR_SECRET, secret);
  }

  /**
   * ä½¿ç”¨æµ‹è¯•å¯†é’¥
   */
  useTestKey(): void {
    localStorage.setItem(STORAGE_KEYS.USE_TEST_KEY, 'true');
  }

  /**
   * æ¸…é™¤æ‰€æœ‰å¯†é’¥
   */
  clearAll(): void {
    Object.values(STORAGE_KEYS).forEach(key => {
      localStorage.removeItem(key);
    });
  }
}

export default new StorageService();
```

---

## é”™è¯¯å¤„ç†æœºåˆ¶

### é”™è¯¯ç±»å‹å’Œå¤„ç†ç­–ç•¥

| é”™è¯¯ç±»å‹ | é”™è¯¯ç  | å¤„ç†ç­–ç•¥ |
|---------|--------|---------|
| APIå¯†é’¥æ— æ•ˆ | INVALID_API_KEY | æç¤ºç”¨æˆ·é‡æ–°è¾“å…¥å¯†é’¥ |
| ç½‘ç»œè¶…æ—¶ | NETWORK_TIMEOUT | è‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œé—´éš”é€’å¢ |
| è¯·æ±‚é™æµ | RATE_LIMIT | ç­‰å¾…åé‡è¯•ï¼Œæç¤ºç”¨æˆ·é™ä½é¢‘ç‡ |
| æ–‡ä»¶è¿‡å¤§ | FILE_TOO_LARGE | æç¤ºæ–‡ä»¶å¤§å°é™åˆ¶ |
| æ ¼å¼ä¸æ”¯æŒ | UNSUPPORTED_FORMAT | æ˜¾ç¤ºæ”¯æŒçš„æ ¼å¼åˆ—è¡¨ |
| å‘é‡åŒ–å¤±è´¥ | EMBEDDING_ERROR | è®°å½•æ—¥å¿—ï¼Œå›é€€åˆ°æ™®é€šå¯¹è¯ |
| æ•°å­—äººè¿æ¥å¤±è´¥ | AVATAR_CONNECTION_ERROR | æ˜¾ç¤ºç¦»çº¿æ¨¡å¼é€‰é¡¹ |
| SDKåˆå§‹åŒ–å¤±è´¥ | SDK_INIT_ERROR | æç¤ºåˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œ |

### é”™è¯¯ä¸­é—´ä»¶

**error.middleware.ts**
```typescript
import { Request, Response, NextFunction } from 'express';

export class AppError extends Error {
  constructor(
    public statusCode: number,
    public code: string,
    message: string
  ) {
    super(message);
    this.name = 'AppError';
  }
}

export const errorHandler = (
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  console.error('[Error]', err);

  if (err instanceof AppError) {
    return res.status(err.statusCode).json({
      success: false,
      code: err.code,
      message: err.message
    });
  }

  // æœªçŸ¥é”™è¯¯
  res.status(500).json({
    success: false,
    code: 'INTERNAL_ERROR',
    message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'
  });
};

/**
 * å¼‚æ­¥è·¯ç”±åŒ…è£…å™¨
 */
export const asyncHandler = (
  fn: (req: Request, res: Response, next: NextFunction) => Promise<any>
) => {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};
```

### å‰ç«¯é”™è¯¯å¤„ç†

**errorHandler.tsx**
```typescript
import React, { createContext, useContext, useState } from 'react';

interface ErrorContextType {
  error: string | null;
  showError: (message: string) => void;
  clearError: () => void;
}

const ErrorContext = createContext<ErrorContextType | null>(null);

export const ErrorProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [error, setError] = useState<string | null>(null);

  const showError = (message: string) => {
    setError(message);
    // 5ç§’åè‡ªåŠ¨æ¸…é™¤
    setTimeout(() => setError(null), 5000);
  };

  const clearError = () => setError(null);

  return (
    <ErrorContext.Provider value={{ error, showError, clearError }}>
      {children}
      {error && (
        <div className="fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg animate-slide-in">
          <div className="flex items-center space-x-3">
            <span>âš ï¸</span>
            <p>{error}</p>
            <button onClick={clearError} className="ml-4 hover:opacity-80">âœ•</button>
          </div>
        </div>
      )}
    </ErrorContext.Provider>
  );
};

export const useError = () => {
  const context = useContext(ErrorContext);
  if (!context) {
    throw new Error('useError must be used within ErrorProvider');
  }
  return context;
};
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å‘é‡æ£€ç´¢ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ•ˆæœ |
|-------|------|------|
| æ‰¹é‡å‘é‡åŒ– | å°†å¤šä¸ªæ–‡æœ¬åˆå¹¶ä¸ºä¸€æ¬¡APIè°ƒç”¨ | å‡å°‘APIè°ƒç”¨æ¬¡æ•° |
| å‘é‡ç¼“å­˜ | ç¼“å­˜å·²ç”Ÿæˆçš„å‘é‡ | é¿å…é‡å¤è®¡ç®— |
| ç´¢å¼•ä¼˜åŒ– | ä½¿ç”¨ä¸“ä¸šå‘é‡æ•°æ®åº“(Pinecone/Milvus) | æå‡æ£€ç´¢é€Ÿåº¦ |
| åˆ†å—ç­–ç•¥ | æŒ‰è¯­ä¹‰è¾¹ç•Œåˆ†å—ï¼Œè€Œéå›ºå®šé•¿åº¦ | æå‡æ£€ç´¢å‡†ç¡®åº¦ |

### 2. æµå¼å“åº”ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ•ˆæœ |
|-------|------|------|
| å¢é‡æ¸²æŸ“ | ä½¿ç”¨ReactçŠ¶æ€å¢é‡æ›´æ–° | å‡å°‘é‡æ¸²æŸ“ |
| è™šæ‹Ÿåˆ—è¡¨ | é•¿æ¶ˆæ¯åˆ—è¡¨ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ | å‡å°‘DOMèŠ‚ç‚¹ |
| é˜²æŠ–è¾“å…¥ | è¾“å…¥æ¡†é˜²æŠ–å¤„ç† | å‡å°‘æ— æ•ˆè¯·æ±‚ |
| è¯·æ±‚å–æ¶ˆ | ç»„ä»¶å¸è½½æ—¶å–æ¶ˆpendingè¯·æ±‚ | é¿å…å†…å­˜æ³„æ¼ |

### 3. å†…å­˜ç®¡ç†

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ•ˆæœ |
|-------|------|------|
| æ¶ˆæ¯å†å²é™åˆ¶ | é™åˆ¶å†å²æ¶ˆæ¯æ•°é‡(å¦‚æœ€è¿‘50æ¡) | æ§åˆ¶å†…å­˜å ç”¨ |
| å›¾ç‰‡æ‡’åŠ è½½ | å›¾ç‰‡æ‡’åŠ è½½+ç¼©ç•¥å›¾ | å‡å°‘åˆå§‹åŠ è½½ |
| å‘é‡å­˜å‚¨é™åˆ¶ | å†…å­˜å­˜å‚¨é™åˆ¶æ–‡æ¡£æ•°é‡ | é¿å…å†…å­˜æº¢å‡º |
| å®šæœŸæ¸…ç† | å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ | é‡Šæ”¾å†…å­˜ |

### 4. ç½‘ç»œä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ•ˆæœ |
|-------|------|------|
| CDNåŠ é€Ÿ | é™æ€èµ„æºä½¿ç”¨CDN | æå‡åŠ è½½é€Ÿåº¦ |
| è¯·æ±‚åˆå¹¶ | åˆå¹¶å¤šä¸ªå°è¯·æ±‚ | å‡å°‘RTT |
| å‹ç¼©ä¼ è¾“ | å¯ç”¨gzip/brotliå‹ç¼© | å‡å°‘ä¼ è¾“é‡ |
| é¢„è¿æ¥ | é¢„è¿æ¥åˆ°APIæœåŠ¡å™¨ | å‡å°‘è¿æ¥å»¶è¿Ÿ |

---

## APIæ¥å£æ–‡æ¡£

### çŸ¥è¯†åº“ç®¡ç†æ¥å£

#### POST /api/knowledge/upload

ä¸Šä¼ çŸ¥è¯†åº“æ–‡ä»¶

**è¯·æ±‚**
- Content-Type: multipart/form-data
- Body: file (æ–‡ä»¶)

**å“åº”**
```json
{
  "success": true,
  "filename": "example.pdf",
  "chunks": 15,
  "message": "ä¸Šä¼ å¹¶å¤„ç†æˆåŠŸ"
}
```

#### GET /api/knowledge/list

è·å–çŸ¥è¯†åº“æ–‡ä»¶åˆ—è¡¨

**å“åº”**
```json
{
  "success": true,
  "files": [
    {
      "filename": "city_history.pdf",
      "uploadTime": 1704067200000,
      "chunkCount": 25
    }
  ]
}
```

#### DELETE /api/knowledge/file

åˆ é™¤å•ä¸ªçŸ¥è¯†åº“æ–‡ä»¶

**è¯·æ±‚ä½“**
```json
{
  "filename": "example.pdf"
}
```

**å“åº”**
```json
{
  "success": true,
  "message": "åˆ é™¤æˆåŠŸ"
}
```

#### DELETE /api/knowledge/all

æ¸…ç©ºæ‰€æœ‰çŸ¥è¯†åº“

**å“åº”**
```json
{
  "success": true,
  "message": "çŸ¥è¯†åº“å·²æ¸…ç©º"
}
```

### å¯¹è¯æ¥å£

#### POST /api/chat/stream

æµå¼å¯¹è¯ï¼ˆæ”¯æŒRAGï¼‰

**è¯·æ±‚ä½“**
```json
{
  "message": "è¯·ä»‹ç»ä¸€ä¸‹è¿™åº§åŸå¸‚çš„å†å²",
  "conversationHistory": [],
  "modelscopeApiKey": "ms-xxx",
  "enableRAG": true
}
```

**å“åº”æµ**
```
data: {"type":"start"}

data: {"type":"content","data":"è¿™åº§"}

data: {"type":"content","data":"åŸå¸‚"}

...

data: {"type":"end"}
```

#### POST /api/chat/image

å›¾ç‰‡ç†è§£å¯¹è¯

**è¯·æ±‚ä½“**
```json
{
  "imageUrl": "https://example.com/image.jpg",
  "question": "è¯·æè¿°è¿™å¹…å›¾ç‰‡",
  "modelscopeApiKey": "ms-xxx"
}
```

**å“åº”**
```json
{
  "success": true,
  "response": "è¿™æ˜¯ä¸€å¹…å±•ç¤ºåŸå¸‚..."
}
```

---

## éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒå¯åŠ¨

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. å¯åŠ¨åç«¯æœåŠ¡ï¼ˆæ–°ç»ˆç«¯çª—å£ï¼‰
npm run dev:server

# 3. å¯åŠ¨å‰ç«¯æœåŠ¡ï¼ˆæ–°ç»ˆç«¯çª—å£ï¼‰
npm run dev:client
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# 1. æ„å»ºå‰ç«¯
npm run build

# 2. å¯åŠ¨åç«¯
npm run start

# å‰ç«¯é™æ€æ–‡ä»¶ç”±åç«¯ExpressæœåŠ¡æ‰˜ç®¡
```

### ç¯å¢ƒè¦æ±‚

| é¡¹ç›® | è¦æ±‚ |
|------|------|
| Node.js | 18.x æˆ–æ›´é«˜ç‰ˆæœ¬ |
| æµè§ˆå™¨ | Chrome/Edge 90+ï¼ˆæ”¯æŒWeb Speech APIï¼‰ |
| ç½‘ç»œ | éœ€è¦è®¿é—®é­”çæ˜Ÿäº‘å’Œé­”æ­ç¤¾åŒºAPI |
| ç£ç›˜ç©ºé—´ | è‡³å°‘500MBï¼ˆç”¨äºä¸Šä¼ æ–‡ä»¶å­˜å‚¨ï¼‰ |

---

## å¿«é€Ÿå¼€å§‹

### å¿«é€Ÿå¼€å§‹æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯åŠ¨åº”ç”¨                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¯†é’¥é…ç½®ç•Œé¢                                     â”‚
â”‚  [ä½¿ç”¨æµ‹è¯•å¯†é’¥]  [æ‰‹åŠ¨è¾“å…¥å¯†é’¥]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¿æ¥æ•°å­—äºº                                        â”‚
â”‚  ç‚¹å‡»"è¿æ¥æ•°å­—äºº" â†’ ç­‰å¾…åˆå§‹åŒ– â†’ çŠ¶æ€å˜ä¸º"åœ¨çº¿"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çŸ¥è¯†åº“å‡†å¤‡                                        â”‚
â”‚  [ä½¿ç”¨å†…ç½®çŸ¥è¯†åº“]  [ä¸Šä¼ è‡ªå®šä¹‰çŸ¥è¯†åº“]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¼€å§‹è®²è§£                                          â”‚
â”‚  è‡ªç”±æé—® | é€‰æ‹©ä¸»é¢˜ | ä¸Šä¼ å›¾ç‰‡æé—®                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†…ç½®ä¸»é¢˜

ç³»ç»Ÿé¢„è®¾ä»¥ä¸‹è®²è§£ä¸»é¢˜ï¼š

| ä¸»é¢˜ | æè¿° | å¿«æ·é—®é¢˜ç¤ºä¾‹ |
|------|------|-------------|
| åŸå¸‚å†å² | ä»‹ç»åŸå¸‚çš„å†å²å˜è¿ | "è¿™åº§åŸå¸‚æœ‰ä»€ä¹ˆå†å²æ•…äº‹ï¼Ÿ" |
| æœªæ¥è§„åˆ’ | å±•ç¤ºåŸå¸‚å‘å±•è“å›¾ | "è¿™åº§åŸå¸‚æœªæ¥æœ‰ä»€ä¹ˆè§„åˆ’ï¼Ÿ" |
| æ–‡åŒ–æ™¯ç‚¹ | æ¨èè‘—åæ–‡åŒ–æ™¯ç‚¹ | "æœ‰å“ªäº›å€¼å¾—æ¸¸è§ˆçš„æ™¯ç‚¹ï¼Ÿ" |
| ç»æµå‘å±• | ä»‹ç»ç»æµå‘å±•æˆå°± | "è¿™åº§åŸå¸‚çš„ç»æµæ€ä¹ˆæ ·ï¼Ÿ" |

### é¦–æ¬¡ä½¿ç”¨æ­¥éª¤

1. **å¯åŠ¨åº”ç”¨**
   ```bash
   npm install
   npm run dev
   ```

2. **é…ç½®å¯†é’¥**
   - é¦–æ¬¡è®¿é—®ä¼šæ˜¾ç¤ºå¯†é’¥é…ç½®ç•Œé¢
   - å¯é€‰æ‹©"ä½¿ç”¨æµ‹è¯•å¯†é’¥"å¿«é€Ÿä½“éªŒ
   - æˆ–æ‰‹åŠ¨è¾“å…¥è‡ªå·±çš„é­”æ­ç¤¾åŒºAPIå¯†é’¥

3. **è¿æ¥æ•°å­—äºº**
   - è¾“å…¥æ•°å­—äººApp IDå’ŒSecret
   - ç‚¹å‡»"è¿æ¥æ•°å­—äºº"æŒ‰é’®
   - ç­‰å¾…åˆå§‹åŒ–å®Œæˆ

4. **å‡†å¤‡çŸ¥è¯†åº“**
   - ç³»ç»Ÿå†…ç½®åŸºç¡€åŸå¸‚çŸ¥è¯†åº“
   - å¯ä¸Šä¼ è‡ªå®šä¹‰çŸ¥è¯†åº“æ–‡ä»¶

5. **å¼€å§‹å¯¹è¯**
   - ç‚¹å‡»å¿«æ·ä¸»é¢˜æˆ–è‡ªç”±æé—®
   - æ”¯æŒæ–‡å­—å’Œå›¾ç‰‡è¾“å…¥
   - æ•°å­—äººä¼šåŒæ­¥è®²è§£

---

## é¡¹ç›®ç‰¹è‰²

1. **æ™ºèƒ½RAGæ£€ç´¢**
   - åŸºäºQwen3-Embedding-8Bçš„å‘é‡åŒ–
   - è¯­ä¹‰ç›¸ä¼¼åº¦ç²¾å‡†åŒ¹é…
   - ä¸Šä¸‹æ–‡å¢å¼ºå›ç­”

2. **å¤šæ¨¡æ€æ”¯æŒ**
   - æ”¯æŒå›¾ç‰‡ç†è§£å¯¹è¯
   - æ–‡å­—+å›¾ç‰‡æ··åˆè¾“å…¥
   - Qwen3-VLå¤§æ¨¡å‹é©±åŠ¨

3. **çµæ´»çŸ¥è¯†åº“**
   - æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼
   - è‡ªåŠ¨åˆ†å—å‘é‡åŒ–
   - å®æ—¶ä¸Šä¼ ç”Ÿæ•ˆ

4. **å¤§å±ä¼˜åŒ–**
   - ä¸“ä¸ºå±•è§ˆå¤§å±è®¾è®¡
   - æ¸…æ™°çš„å­—ä½“å’ŒæŒ‰é’®
   - æ–¹ä¾¿è§¦æ§æ“ä½œ

5. **æ˜“äºéƒ¨ç½²**
   - å¯†é’¥æœ¬åœ°ç®¡ç†
   - æ— éœ€å¤–éƒ¨æ•°æ®åº“
   - æ”¯æŒç¦»çº¿å‘é‡å­˜å‚¨

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.3 | æœ€åæ›´æ–°: 2026-01-04*
